# æˆ‘çš„å‚µå‹™äººç®¡ç† - åŠŸèƒ½æ”¹ç‰ˆèªªæ˜Ž

## ðŸ“‹ æ”¹ç‰ˆæ¦‚è¿°

é‡å°ã€Œæˆ‘çš„å‚µå‹™äººç®¡ç†ã€åŠŸèƒ½é€²è¡Œæ”¹ç‰ˆï¼Œæ–°å¢žç§å¯†æ¬„ä½å’Œå‚™è¨»æ™‚é–“è»¸åŠŸèƒ½ï¼Œè®“æœƒå“¡å¯ä»¥æ›´è©³ç´°åœ°è¨˜éŒ„å’Œç®¡ç†å‚µå‹™è³‡è¨Šã€‚

---

## âœ¨ æ–°å¢žåŠŸèƒ½

### 1. ç§å¯†æ¬„ä½ï¼ˆåƒ…ä¸Šå‚³è€…æœ¬äººå¯è¦‹ï¼‰

åœ¨ã€Œé‚„æ¬¾ç‹€æ³ã€æ¬„ä½æ—é‚Šï¼Œæ–°å¢žä»¥ä¸‹ç§å¯†æ¬„ä½ï¼š

#### é‡‘é¡æ¬„ä½
- **çµæ¸…é‡‘é¡**ï¼šè¨˜éŒ„å‚µå‹™çµæ¸…çš„ç¸½é‡‘é¡ï¼ˆæ•¸å­—æ¬„ä½ï¼‰
- **å·²æ”¶å›žé‡‘é¡**ï¼šè¨˜éŒ„å·²ç¶“æ”¶å›žçš„é‡‘é¡ï¼ˆæ•¸å­—æ¬„ä½ï¼‰
- **å‘†å¸³é‡‘é¡**ï¼šè¨˜éŒ„ç„¡æ³•æ”¶å›žçš„å‘†å¸³é‡‘é¡ï¼ˆæ•¸å­—æ¬„ä½ï¼‰

#### è©•åƒ¹æ¬„ä½
- **å…§éƒ¨è©•åƒ¹**ï¼ˆå¯é¸ï¼‰ï¼š1~5 é¡†æ˜Ÿçš„ã€Œåˆä½œé«”æ„Ÿã€è©•åˆ†ï¼Œç”¨æ–¼è¨˜éŒ„èˆ‡å‚µå‹™äººçš„åˆä½œé«”é©—

#### é‡è¦èªªæ˜Ž
- âœ… é€™äº›æ¬„ä½**åƒ…ä¾›ä¸Šå‚³è€…æœ¬äººæŸ¥çœ‹å’Œç·¨è¼¯**
- âœ… **ä¸æœƒé¡¯ç¤º**åœ¨å…¶ä»–æœƒå“¡çš„æŸ¥è©¢çµæžœä¸­
- âœ… ç”¨é€”æ˜¯è®“ä¸Šå‚³è€…è¨˜éŒ„ç´°ç¯€ã€è¨ˆç®—æç›Š

---

### 2. å‚™è¨»æ™‚é–“è»¸åŠŸèƒ½

åœ¨ã€Œæˆ‘çš„å‚µå‹™äººç®¡ç†ã€é é¢ä¸­ï¼š

#### åŠŸèƒ½ç‰¹é»ž
- æ¯ä¸€åˆ—å‚µå‹™äººè¨˜éŒ„çš„å³å´æœ‰ã€ŒðŸ“ å‚™è¨»ç´€éŒ„ã€æŒ‰éˆ•
- é»žæ“ŠæŒ‰éˆ•å¾Œé–‹å•Ÿå‚™è¨»æ™‚é–“è»¸ï¼ˆTimelineï¼‰ä»‹é¢
- æ™‚é–“è»¸é¡¯ç¤ºè©²å‚µå‹™äººçš„æ‰€æœ‰å‚™è¨»è¨˜éŒ„ï¼ŒæŒ‰æ™‚é–“é †åºæŽ’åˆ—
- å¯ä»¥åœ¨æ™‚é–“è»¸ä¸­æ–°å¢žæ–°çš„å‚™è¨»

#### ä½¿ç”¨å ´æ™¯
- è¨˜éŒ„èˆ‡å‚µå‹™äººçš„æºé€šæ­·ç¨‹
- è¨˜éŒ„é‚„æ¬¾é€²åº¦å’Œè®ŠåŒ–
- è¨˜éŒ„é‡è¦äº‹ä»¶å’Œæ±ºç­–
- å»ºç«‹å®Œæ•´çš„å‚µå‹™ç®¡ç†æ­·å²è¨˜éŒ„

---

## ðŸ” è³‡æ–™åŒæ­¥è¦å‰‡

### å…¬é–‹è³‡è¨Šï¼ˆç¶­æŒç¾æœ‰åŠŸèƒ½ï¼‰
ä»¥ä¸‹è³‡è¨ŠæœƒåŒæ­¥åˆ°å…¶ä»–æœƒå“¡çš„æŸ¥è©¢çµæžœï¼š
- âœ… **é‚„æ¬¾ç‹€æ³**ï¼šå¾…è§€å¯Ÿã€æ­£å¸¸ã€çµæ¸…ã€ç–²å‹žã€å‘†å¸³ç­‰
- âœ… **å‚™è¨»**ï¼šåŽŸæœ‰çš„å‚™è¨»æ¬„ä½ï¼ˆåœ¨ä¸Šå‚³æ™‚å¡«å¯«çš„ï¼‰

### ç§å¯†è³‡è¨Šï¼ˆåƒ…ä¸Šå‚³è€…å¯è¦‹ï¼‰
ä»¥ä¸‹è³‡è¨Š**ä¸æœƒåŒæ­¥**åˆ°æŸ¥è©¢çµæžœï¼Œå…¶ä»–æœƒå“¡çœ‹ä¸åˆ°ï¼š
- ðŸ”’ **çµæ¸…é‡‘é¡**
- ðŸ”’ **å·²æ”¶å›žé‡‘é¡**
- ðŸ”’ **å‘†å¸³é‡‘é¡**
- ðŸ”’ **å…§éƒ¨è©•åƒ¹**ï¼ˆ1-5 æ˜Ÿï¼‰
- ðŸ”’ **å‚™è¨»æ™‚é–“è»¸**çš„æ‰€æœ‰å‚™è¨»è¨˜éŒ„

---

## ðŸŽ¨ UI è®Šæ›´

### æˆ‘çš„å‚µå‹™äººç®¡ç†é é¢

#### è¡¨æ ¼æ–°å¢žæ¬„ä½
åœ¨ã€Œé‚„æ¬¾ç‹€æ³ã€å’Œã€Œæ“ä½œã€ä¹‹é–“æ–°å¢žã€Œç§å¯†æ¬„ä½ ðŸ”’ã€æ¬„ä½ï¼š

```
| å‚µå‹™äººè³‡è¨Š | å±…ä½åœ° | å‚µå‹™æ—¥æœŸ | ç¥¨é¢é‡‘é¡ | é‚„æ¬¾é…åˆ | é‚„æ¬¾ç‹€æ³ | ç§å¯†æ¬„ä½ ðŸ”’ | æ“ä½œ |
```

#### ç§å¯†æ¬„ä½é¡¯ç¤º
- é¡¯ç¤ºå…§éƒ¨è©•åƒ¹ï¼ˆæ˜Ÿç´šï¼‰
- é¡¯ç¤ºå·²å¡«å¯«çš„é‡‘é¡è³‡è¨Šï¼ˆçµæ¸…ã€æ”¶å›žã€å‘†å¸³ï¼‰
- æä¾›ã€Œæ–°å¢žã€æˆ–ã€Œç·¨è¼¯ã€æŒ‰éˆ•

#### æ“ä½œæ¬„ä½
- **ðŸ“ å‚™è¨»ç´€éŒ„**ï¼šé–‹å•Ÿå‚™è¨»æ™‚é–“è»¸ Modal
- **æŸ¥çœ‹è©³æƒ…**ï¼šé¡¯ç¤ºå®Œæ•´çš„å‚µå‹™äººè³‡è¨Šï¼ˆåŽŸæœ‰åŠŸèƒ½ï¼‰

---

## ðŸ› ï¸ æŠ€è¡“å¯¦ä½œ

### è³‡æ–™åº«è®Šæ›´

#### 1. debt_records è¡¨æ–°å¢žæ¬„ä½
```sql
ALTER TABLE debt_records
ADD COLUMN settled_amount DECIMAL(15,2),      -- çµæ¸…é‡‘é¡
ADD COLUMN recovered_amount DECIMAL(15,2),    -- å·²æ”¶å›žé‡‘é¡
ADD COLUMN bad_debt_amount DECIMAL(15,2),     -- å‘†å¸³é‡‘é¡
ADD COLUMN internal_rating INTEGER CHECK (internal_rating >= 1 AND internal_rating <= 5);
```

#### 2. æ–°å¢ž debt_record_notes è¡¨
```sql
CREATE TABLE debt_record_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  debt_record_id UUID NOT NULL REFERENCES debt_records(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 3. RLS æ”¿ç­–
- åªæœ‰å‚µå‹™è¨˜éŒ„çš„ä¸Šå‚³è€…å¯ä»¥æŸ¥çœ‹å’Œæ–°å¢žå‚™è¨»
- ç®¡ç†å“¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å‚™è¨»ï¼ˆä½†ä¸èƒ½ä¿®æ”¹ï¼‰
- ç§å¯†æ¬„ä½é€éŽ API å±¤ç´šæŽ§åˆ¶ï¼Œåªè¿”å›žçµ¦ä¸Šå‚³è€…

---

### API è®Šæ›´

#### 1. å‚™è¨»æ™‚é–“è»¸ API

**å–å¾—å‚™è¨»åˆ—è¡¨**
```
GET /api/debts/[debtId]/notes
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "debt_record_id": "uuid",
      "user_id": "uuid",
      "content": "å‚™è¨»å…§å®¹",
      "created_at": "2025-01-17T10:00:00Z",
      "updated_at": "2025-01-17T10:00:00Z"
    }
  ]
}
```

**æ–°å¢žå‚™è¨»**
```
POST /api/debts/[debtId]/notes
Authorization: Bearer {token}
Content-Type: application/json

{
  "content": "å‚™è¨»å…§å®¹"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "debt_record_id": "uuid",
    "user_id": "uuid",
    "content": "å‚™è¨»å…§å®¹",
    "created_at": "2025-01-17T10:00:00Z",
    "updated_at": "2025-01-17T10:00:00Z"
  }
}
```

#### 2. ç§å¯†æ¬„ä½ API

**æ›´æ–°ç§å¯†æ¬„ä½**
```
PATCH /api/debts/[debtId]/private-fields
Authorization: Bearer {token}
Content-Type: application/json

{
  "settled_amount": 100000,
  "recovered_amount": 50000,
  "bad_debt_amount": 30000,
  "internal_rating": 3
}

Response:
{
  "success": true,
  "data": {
    // å®Œæ•´çš„å‚µå‹™è¨˜éŒ„è³‡æ–™ï¼ˆåŒ…å«ç§å¯†æ¬„ä½ï¼‰
  }
}
```

---

### å‰ç«¯å…ƒä»¶

#### 1. NotesTimelineModal
- è·¯å¾‘ï¼š`src/components/debts/NotesTimelineModal.tsx`
- åŠŸèƒ½ï¼šé¡¯ç¤ºå‚™è¨»æ™‚é–“è»¸ï¼Œæ”¯æ´æ–°å¢žå‚™è¨»
- Propsï¼š
  - `debtRecordId`: å‚µå‹™è¨˜éŒ„ ID
  - `debtorName`: å‚µå‹™äººå§“å
  - `isOpen`: Modal æ˜¯å¦é–‹å•Ÿ
  - `onClose`: é—œé–‰ Modal çš„å›žèª¿å‡½æ•¸

#### 2. PrivateFieldsModal
- è·¯å¾‘ï¼š`src/components/debts/PrivateFieldsModal.tsx`
- åŠŸèƒ½ï¼šç·¨è¼¯ç§å¯†æ¬„ä½ï¼ˆé‡‘é¡ã€è©•åƒ¹ï¼‰
- Propsï¼š
  - `debtRecordId`: å‚µå‹™è¨˜éŒ„ ID
  - `debtorName`: å‚µå‹™äººå§“å
  - `initialData`: åˆå§‹è³‡æ–™
  - `isOpen`: Modal æ˜¯å¦é–‹å•Ÿ
  - `onClose`: é—œé–‰ Modal çš„å›žèª¿å‡½æ•¸
  - `onSuccess`: æˆåŠŸå¾Œçš„å›žèª¿å‡½æ•¸

---

## ðŸ“ ä½¿ç”¨èªªæ˜Ž

### å¦‚ä½•ä½¿ç”¨ç§å¯†æ¬„ä½

1. é€²å…¥ã€Œæˆ‘çš„å‚µå‹™äººç®¡ç†ã€é é¢
2. åœ¨ã€Œç§å¯†æ¬„ä½ ðŸ”’ã€æ¬„ä½ä¸­ï¼Œé»žæ“Šã€Œæ–°å¢žã€æˆ–ã€Œç·¨è¼¯ã€æŒ‰éˆ•
3. åœ¨å½ˆå‡ºçš„ Modal ä¸­å¡«å¯«ï¼š
   - çµæ¸…é‡‘é¡
   - å·²æ”¶å›žé‡‘é¡
   - å‘†å¸³é‡‘é¡
   - å…§éƒ¨è©•åƒ¹ï¼ˆé»žæ“Šæ˜Ÿæ˜Ÿè©•åˆ†ï¼‰
4. é»žæ“Šã€Œå„²å­˜ã€æŒ‰éˆ•

### å¦‚ä½•ä½¿ç”¨å‚™è¨»æ™‚é–“è»¸

1. é€²å…¥ã€Œæˆ‘çš„å‚µå‹™äººç®¡ç†ã€é é¢
2. åœ¨ã€Œæ“ä½œã€æ¬„ä½ä¸­ï¼Œé»žæ“Šã€ŒðŸ“ å‚™è¨»ç´€éŒ„ã€æŒ‰éˆ•
3. åœ¨å½ˆå‡ºçš„ Modal ä¸­ï¼š
   - æŸ¥çœ‹æ­·å²å‚™è¨»è¨˜éŒ„ï¼ˆæŒ‰æ™‚é–“å€’åºæŽ’åˆ—ï¼‰
   - åœ¨ã€Œæ–°å¢žå‚™è¨»ã€æ¬„ä½ä¸­è¼¸å…¥æ–°çš„å‚™è¨»å…§å®¹
   - é»žæ“Šã€Œæ–°å¢žå‚™è¨»ã€æŒ‰éˆ•
4. å‚™è¨»æœƒç«‹å³é¡¯ç¤ºåœ¨æ™‚é–“è»¸ä¸­

---

## ðŸ”’ å®‰å…¨æ€§

### è³‡æ–™éš”é›¢
- ç§å¯†æ¬„ä½åªèƒ½ç”±ä¸Šå‚³è€…æœ¬äººæŸ¥çœ‹å’Œç·¨è¼¯
- å‚™è¨»æ™‚é–“è»¸åªèƒ½ç”±ä¸Šå‚³è€…æœ¬äººæŸ¥çœ‹å’Œæ–°å¢ž
- ç®¡ç†å“¡å¯ä»¥æŸ¥çœ‹å‚™è¨»ï¼ˆç”¨æ–¼å¯©è¨ˆï¼‰ï¼Œä½†ä¸èƒ½ä¿®æ”¹

### API é©—è­‰
- æ‰€æœ‰ API éƒ½éœ€è¦ JWT token é©—è­‰
- é©—è­‰ä½¿ç”¨è€…æ˜¯å¦ç‚ºå‚µå‹™è¨˜éŒ„çš„ä¸Šå‚³è€…
- ä½¿ç”¨ Supabase RLS æ”¿ç­–é€²è¡Œè³‡æ–™åº«å±¤ç´šçš„å­˜å–æŽ§åˆ¶

### è³‡æ–™åº«å±¤ç´šä¿è­·
- å•Ÿç”¨ Row Level Security (RLS)
- å»ºç«‹åš´æ ¼çš„ RLS æ”¿ç­–
- ç¢ºä¿å³ä½¿ API è¢«ç¹žéŽï¼Œè³‡æ–™åº«å±¤ç´šä¹Ÿæœƒé˜»æ“‹éžæ³•å­˜å–

---

## ðŸ“Š è³‡æ–™çµ±è¨ˆ

ç§å¯†æ¬„ä½å¯ä»¥ç”¨æ–¼è¨ˆç®—ï¼š
- **ç¸½çµæ¸…é‡‘é¡**ï¼šæ‰€æœ‰å‚µå‹™çš„çµæ¸…é‡‘é¡ç¸½å’Œ
- **ç¸½æ”¶å›žé‡‘é¡**ï¼šæ‰€æœ‰å‚µå‹™çš„å·²æ”¶å›žé‡‘é¡ç¸½å’Œ
- **ç¸½å‘†å¸³é‡‘é¡**ï¼šæ‰€æœ‰å‚µå‹™çš„å‘†å¸³é‡‘é¡ç¸½å’Œ
- **å¹³å‡åˆä½œè©•åƒ¹**ï¼šæ‰€æœ‰å‚µå‹™çš„å…§éƒ¨è©•åƒ¹å¹³å‡å€¼

æœªä¾†å¯ä»¥åœ¨çµ±è¨ˆé é¢ä¸­æ–°å¢žé€™äº›ç§å¯†çµ±è¨ˆè³‡è¨Šã€‚

---

## ðŸŽ¯ ä½¿ç”¨å ´æ™¯ç¯„ä¾‹

### å ´æ™¯ 1ï¼šè¨˜éŒ„å‚µå‹™çµæ¸…éŽç¨‹
1. å‚µå‹™äººåŽŸæœ¬æ¬ æ¬¾ 100,000 å…ƒ
2. ç¶“éŽå”å•†ï¼Œçµæ¸…é‡‘é¡ç‚º 80,000 å…ƒ
3. åˆ†ä¸‰æ¬¡æ”¶å›žï¼š30,000 + 30,000 + 20,000
4. åœ¨ç§å¯†æ¬„ä½ä¸­è¨˜éŒ„ï¼š
   - çµæ¸…é‡‘é¡ï¼š80,000
   - å·²æ”¶å›žé‡‘é¡ï¼š80,000
   - å‘†å¸³é‡‘é¡ï¼š20,000ï¼ˆ100,000 - 80,000ï¼‰
   - å…§éƒ¨è©•åƒ¹ï¼š4 æ˜Ÿï¼ˆåˆä½œè‰¯å¥½ï¼‰

### å ´æ™¯ 2ï¼šä½¿ç”¨å‚™è¨»æ™‚é–“è»¸è¿½è¹¤é€²åº¦
1. 2025-01-10ï¼šã€Œé¦–æ¬¡è¯ç¹«ï¼Œå‚µå‹™äººè¡¨ç¤ºé¡˜æ„é‚„æ¬¾ã€
2. 2025-01-15ï¼šã€Œæ”¶åˆ°ç¬¬ä¸€ç­†æ¬¾é … 30,000 å…ƒã€
3. 2025-01-20ï¼šã€Œæ”¶åˆ°ç¬¬äºŒç­†æ¬¾é … 30,000 å…ƒã€
4. 2025-01-25ï¼šã€Œæ”¶åˆ°æœ€å¾Œä¸€ç­†æ¬¾é … 20,000 å…ƒï¼Œå‚µå‹™çµæ¸…ã€

---

## âœ… æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] ç§å¯†æ¬„ä½åªæœ‰ä¸Šå‚³è€…å¯è¦‹
- [ ] ç§å¯†æ¬„ä½ä¸æœƒå‡ºç¾åœ¨å…¶ä»–æœƒå“¡çš„æŸ¥è©¢çµæžœä¸­
- [ ] å‚™è¨»æ™‚é–“è»¸åªæœ‰ä¸Šå‚³è€…å¯è¦‹
- [ ] å¯ä»¥æˆåŠŸæ–°å¢žå‚™è¨»
- [ ] å‚™è¨»æŒ‰æ™‚é–“å€’åºæŽ’åˆ—
- [ ] å¯ä»¥æˆåŠŸç·¨è¼¯ç§å¯†æ¬„ä½
- [ ] å…§éƒ¨è©•åƒ¹æ˜Ÿç´šé¡¯ç¤ºæ­£ç¢º
- [ ] é‡‘é¡æ ¼å¼åŒ–é¡¯ç¤ºæ­£ç¢º
- [ ] Modal é–‹å•Ÿå’Œé—œé–‰æ­£å¸¸
- [ ] è³‡æ–™æ›´æ–°å¾Œé é¢è‡ªå‹•é‡æ–°è¼‰å…¥

---

## ðŸ“… éƒ¨ç½²è³‡è¨Š

- **Migration æª”æ¡ˆ**ï¼š`supabase/migrations/20250117_add_private_fields_and_notes_timeline.sql`
- **éƒ¨ç½²æ—¥æœŸ**ï¼š2025-01-17
- **Git Commit**ï¼š5f99755

---

## ðŸ”„ æœªä¾†æ”¹é€²æ–¹å‘

1. **ç§å¯†çµ±è¨ˆå„€è¡¨æ¿**ï¼šæ–°å¢žå°ˆé–€çš„çµ±è¨ˆé é¢ï¼Œé¡¯ç¤ºç§å¯†æ¬„ä½çš„çµ±è¨ˆè³‡è¨Š
2. **å‚™è¨»æœå°‹åŠŸèƒ½**ï¼šåœ¨å‚™è¨»æ™‚é–“è»¸ä¸­æ–°å¢žæœå°‹åŠŸèƒ½
3. **å‚™è¨»ç·¨è¼¯åŠŸèƒ½**ï¼šå…è¨±ç·¨è¼¯å·²æ–°å¢žçš„å‚™è¨»
4. **å‚™è¨»é™„ä»¶**ï¼šæ”¯æ´åœ¨å‚™è¨»ä¸­ä¸Šå‚³é™„ä»¶ï¼ˆåœ–ç‰‡ã€æ–‡ä»¶ï¼‰
5. **åŒ¯å‡ºåŠŸèƒ½**ï¼šåŒ¯å‡ºç§å¯†è³‡æ–™å’Œå‚™è¨»æ™‚é–“è»¸ç‚º Excel æˆ– PDF
6. **æé†’åŠŸèƒ½**ï¼šæ ¹æ“šå‚™è¨»å…§å®¹è¨­å®šæé†’ï¼ˆä¾‹å¦‚ï¼šä¸‹æ¬¡è¯ç¹«æ™‚é–“ï¼‰

---

## ðŸ“ž æŠ€è¡“æ”¯æ´

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠã€‚

