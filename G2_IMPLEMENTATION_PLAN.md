# éšæ®µ G.2ï¼šæ´»èºåº¦é»æ•¸è¨ˆç®—é‚è¼¯ - å¯¦ä½œè¨ˆåŠƒ

**ç‰ˆæœ¬**ï¼šv1.0  
**æ—¥æœŸ**ï¼š2025-01-15  
**é ä¼°æ™‚é–“**ï¼š1-2 å¤©

---

## ğŸ“‹ å¯¦ä½œç›®æ¨™

å»ºç«‹å®Œæ•´çš„æ´»èºåº¦é»æ•¸è¨ˆç®—ç³»çµ±ï¼Œæ•´åˆåˆ°ç¾æœ‰çš„ä¸Šå‚³ã€æŸ¥è©¢ã€æŒ‰è®šã€ç™»å…¥åŠŸèƒ½ä¸­ã€‚

---

## ğŸ¯ éœ€è¦æ•´åˆçš„ç¾æœ‰ API

### 1. ä¸Šå‚³å‚µå‹™è³‡æ–™
- **æª”æ¡ˆ**ï¼š`src/app/api/debts/upload/route.ts`
- **æ•´åˆä½ç½®**ï¼šç¬¬ 258 è¡Œä¹‹å¾Œï¼ˆæˆåŠŸä¸Šå‚³å¾Œï¼‰
- **éœ€è¦æ–°å¢**ï¼šå‘¼å«æ´»èºåº¦é»æ•¸ APIï¼Œæ–°å¢ +2 é»

### 2. æŸ¥è©¢å‚µå‹™è³‡æ–™
- **æª”æ¡ˆ**ï¼š`src/app/api/debts/search/route.ts`
- **æ•´åˆä½ç½®**ï¼šç¬¬ 144 è¡Œä¹‹å¾Œï¼ˆæˆåŠŸæŸ¥è©¢å¾Œï¼‰
- **éœ€è¦æ–°å¢**ï¼šå‘¼å«æ´»èºåº¦é»æ•¸ APIï¼Œæ–°å¢ +1 é»

### 3. ç™»å…¥åŠŸèƒ½
- **æª”æ¡ˆ**ï¼š`src/app/api/auth/login/route.ts`
- **æ•´åˆä½ç½®**ï¼šç¬¬ 176 è¡Œä¹‹å¾Œï¼ˆç™»å…¥æˆåŠŸå¾Œï¼‰
- **éœ€è¦æ–°å¢**ï¼šå‘¼å«æ´»èºåº¦é»æ•¸ APIï¼Œæ–°å¢ +3 é»ï¼ˆæ¯æ—¥ç™»å…¥ï¼‰

### 4. æŒ‰è®šåŠŸèƒ½
- **ç‹€æ…‹**ï¼šå°šæœªå¯¦ä½œ
- **éœ€è¦å»ºç«‹**ï¼š`src/app/api/member/like/[memberId]/route.ts`
- **åŠŸèƒ½**ï¼šæŒ‰è®š +1 é»ï¼ˆçµ¦è®šè€…ï¼‰ã€æ”¶è®š +3 é»ï¼ˆè¢«è®šè€…ï¼‰

---

## ğŸ”§ éœ€è¦å»ºç«‹çš„æ–° API

### 1. æ´»èºåº¦é»æ•¸è¨ˆç®— API
- **è·¯å¾‘**ï¼š`src/app/api/activity/add-points/route.ts`
- **æ–¹æ³•**ï¼šPOST
- **åŠŸèƒ½**ï¼š
  - é©—è­‰ä½¿ç”¨è€…èº«ä»½
  - æª¢æŸ¥æ¯æ—¥ä¸Šé™
  - æª¢æŸ¥å†·å»æ™‚é–“
  - æ–°å¢æ´»èºåº¦é»æ•¸
  - è¨˜éŒ„é»æ•¸æ­·å²
  - æª¢æŸ¥æ˜¯å¦å‡ç´š
  - è¿”å›æ–°çš„ç­‰ç´šå’Œé»æ•¸

### 2. ç­‰ç´šå‡ç´šæª¢æŸ¥ API
- **è·¯å¾‘**ï¼š`src/app/api/activity/check-level-up/route.ts`
- **æ–¹æ³•**ï¼šPOST
- **åŠŸèƒ½**ï¼š
  - è¨ˆç®—æœƒå“¡ç•¶å‰ç­‰ç´š
  - æ›´æ–° member_statistics
  - è¿”å›å‡ç´šè³‡è¨Š

### 3. å‹³ç« è§£é–æª¢æŸ¥ API
- **è·¯å¾‘**ï¼š`src/app/api/activity/check-badges/route.ts`
- **æ–¹æ³•**ï¼šPOST
- **åŠŸèƒ½**ï¼š
  - æª¢æŸ¥æ‰€æœ‰å‹³ç« è§£é–æ¢ä»¶
  - è§£é–ç¬¦åˆæ¢ä»¶çš„å‹³ç« 
  - è¿”å›æ–°è§£é–çš„å‹³ç« åˆ—è¡¨

### 4. æŒ‰è®šåŠŸèƒ½ API
- **è·¯å¾‘**ï¼š`src/app/api/member/like/[memberId]/route.ts`
- **æ–¹æ³•**ï¼šPOST
- **åŠŸèƒ½**ï¼š
  - é©—è­‰ä½¿ç”¨è€…èº«ä»½
  - æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±ï¼ˆä¸èƒ½çµ¦è‡ªå·±æŒ‰è®šï¼‰
  - æª¢æŸ¥æ˜¯å¦å·²æŒ‰è®š
  - æ’å…¥æŒ‰è®šè¨˜éŒ„
  - çµ¦è®šè€… +1 é»
  - è¢«è®šè€… +3 é»
  - è¿”å›æˆåŠŸå›æ‡‰

### 5. å–æ¶ˆæŒ‰è®š API
- **è·¯å¾‘**ï¼š`src/app/api/member/unlike/[memberId]/route.ts`
- **æ–¹æ³•**ï¼šPOST
- **åŠŸèƒ½**ï¼š
  - é©—è­‰ä½¿ç”¨è€…èº«ä»½
  - åˆªé™¤æŒ‰è®šè¨˜éŒ„
  - çµ¦è®šè€… -1 é»
  - è¢«è®šè€… -3 é»
  - è¿”å›æˆåŠŸå›æ‡‰

---

## ğŸ“ å¯¦ä½œæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå»ºç«‹æ´»èºåº¦é»æ•¸è¨ˆç®— APIï¼ˆ30 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/activity/add-points/route.ts`

**åŠŸèƒ½**ï¼š
1. é©—è­‰ä½¿ç”¨è€…èº«ä»½
2. é©—è­‰ action åƒæ•¸ï¼ˆupload, query, like_received, like_given, daily_loginï¼‰
3. å¾ activity_point_rules å–å¾—é»æ•¸è¦å‰‡
4. æª¢æŸ¥æ¯æ—¥ä¸Šé™ï¼ˆå¦‚æœæœ‰ï¼‰
5. æª¢æŸ¥å†·å»æ™‚é–“ï¼ˆå¦‚æœæœ‰ï¼‰
6. æ–°å¢æ´»èºåº¦é»æ•¸åˆ° member_statistics
7. è¨˜éŒ„åˆ° activity_point_history
8. å‘¼å«ç­‰ç´šå‡ç´šæª¢æŸ¥
9. è¿”å›æ–°çš„é»æ•¸å’Œç­‰ç´š

---

### æ­¥é©Ÿ 2ï¼šå»ºç«‹ç­‰ç´šå‡ç´šæª¢æŸ¥ APIï¼ˆ20 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/activity/check-level-up/route.ts`

**åŠŸèƒ½**ï¼š
1. é©—è­‰ä½¿ç”¨è€…èº«ä»½
2. å‘¼å« calculate_member_level å‡½æ•¸
3. æ¯”è¼ƒæ–°èˆŠç­‰ç´š
4. å¦‚æœå‡ç´šï¼Œæ›´æ–° member_statistics
5. è¿”å›å‡ç´šè³‡è¨Šï¼ˆæ˜¯å¦å‡ç´šã€æ–°ç­‰ç´šã€æ–°ç¨±è™Ÿã€é…é¡çå‹µï¼‰

---

### æ­¥é©Ÿ 3ï¼šå»ºç«‹å‹³ç« è§£é–æª¢æŸ¥ APIï¼ˆ40 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/activity/check-badges/route.ts`

**åŠŸèƒ½**ï¼š
1. é©—è­‰ä½¿ç”¨è€…èº«ä»½
2. å–å¾—æ‰€æœ‰å•Ÿç”¨çš„å‹³ç« é…ç½®
3. å–å¾—æœƒå“¡çµ±è¨ˆè³‡æ–™
4. é€ä¸€æª¢æŸ¥è§£é–æ¢ä»¶
5. è§£é–ç¬¦åˆæ¢ä»¶çš„å‹³ç« 
6. è¿”å›æ–°è§£é–çš„å‹³ç« åˆ—è¡¨

---

### æ­¥é©Ÿ 4ï¼šå»ºç«‹æŒ‰è®šåŠŸèƒ½ APIï¼ˆ30 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/member/like/[memberId]/route.ts`

**åŠŸèƒ½**ï¼š
1. é©—è­‰ä½¿ç”¨è€…èº«ä»½
2. æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±
3. æª¢æŸ¥æ˜¯å¦å·²æŒ‰è®š
4. æ’å…¥æŒ‰è®šè¨˜éŒ„åˆ° member_likes è¡¨
5. å‘¼å«æ´»èºåº¦é»æ•¸ APIï¼ˆçµ¦è®šè€… +1ï¼Œè¢«è®šè€… +3ï¼‰
6. è¿”å›æˆåŠŸå›æ‡‰

---

### æ­¥é©Ÿ 5ï¼šæ•´åˆåˆ°ä¸Šå‚³ APIï¼ˆ10 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/debts/upload/route.ts`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 258 è¡Œä¹‹å¾Œ

**æ–°å¢ç¨‹å¼ç¢¼**ï¼š
```typescript
// 9. æ–°å¢æ´»èºåº¦é»æ•¸
try {
  await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/activity/add-points`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ action: 'upload' })
  })
} catch (err) {
  console.error('Failed to add activity points:', err)
  // ä¸é˜»å¡ä¸»æµç¨‹
}
```

---

### æ­¥é©Ÿ 6ï¼šæ•´åˆåˆ°æŸ¥è©¢ APIï¼ˆ10 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/debts/search/route.ts`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 144 è¡Œä¹‹å¾Œ

**æ–°å¢ç¨‹å¼ç¢¼**ï¼š
```typescript
// 8. æ–°å¢æ´»èºåº¦é»æ•¸
try {
  await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/activity/add-points`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ action: 'query' })
  })
} catch (err) {
  console.error('Failed to add activity points:', err)
  // ä¸é˜»å¡ä¸»æµç¨‹
}
```

---

### æ­¥é©Ÿ 7ï¼šæ•´åˆåˆ°ç™»å…¥ APIï¼ˆ15 åˆ†é˜ï¼‰

**æª”æ¡ˆ**ï¼š`src/app/api/auth/login/route.ts`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 176 è¡Œä¹‹å¾Œ

**æ–°å¢ç¨‹å¼ç¢¼**ï¼š
```typescript
// 9. è™•ç†æ¯æ—¥ç™»å…¥é»æ•¸å’Œé€£çºŒç™»å…¥å¤©æ•¸
try {
  // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²ç™»å…¥
  const today = new Date().toISOString().split('T')[0]
  const { data: stats } = await supabaseAdmin
    .from('member_statistics')
    .select('last_login_date, consecutive_login_days')
    .eq('user_id', authData.user.id)
    .single()

  const lastLoginDate = stats?.last_login_date
  const shouldAddPoints = lastLoginDate !== today

  if (shouldAddPoints) {
    // è¨ˆç®—é€£çºŒç™»å…¥å¤©æ•¸
    let newConsecutiveDays = 1
    if (lastLoginDate) {
      const yesterday = new Date()
      yesterday.setDate(yesterday.getDate() - 1)
      const yesterdayStr = yesterday.toISOString().split('T')[0]
      
      if (lastLoginDate === yesterdayStr) {
        newConsecutiveDays = (stats?.consecutive_login_days || 0) + 1
      }
    }

    // æ›´æ–°æœ€å¾Œç™»å…¥æ—¥æœŸå’Œé€£çºŒç™»å…¥å¤©æ•¸
    await supabaseAdmin
      .from('member_statistics')
      .update({
        last_login_date: today,
        consecutive_login_days: newConsecutiveDays
      })
      .eq('user_id', authData.user.id)

    // æ–°å¢æ¯æ—¥ç™»å…¥é»æ•¸
    await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/activity/add-points`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authData.session.access_token}`
      },
      body: JSON.stringify({ action: 'daily_login' })
    })
  }
} catch (err) {
  console.error('Failed to process daily login:', err)
  // ä¸é˜»å¡ä¸»æµç¨‹
}
```

---

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

### æ¸¬è©¦ 1ï¼šæ´»èºåº¦é»æ•¸è¨ˆç®—
- [ ] æ¸¬è©¦ä¸Šå‚³å‚µå‹™è³‡æ–™å¾Œç²å¾— +2 é»
- [ ] æ¸¬è©¦æŸ¥è©¢å‚µå‹™è³‡æ–™å¾Œç²å¾— +1 é»
- [ ] æ¸¬è©¦æ¯æ—¥ç™»å…¥å¾Œç²å¾— +3 é»
- [ ] æ¸¬è©¦æŒ‰è®šå¾Œçµ¦è®šè€…ç²å¾— +1 é»
- [ ] æ¸¬è©¦æ”¶è®šå¾Œè¢«è®šè€…ç²å¾— +3 é»

### æ¸¬è©¦ 2ï¼šæ¯æ—¥ä¸Šé™æª¢æŸ¥
- [ ] æ¸¬è©¦ä¸Šå‚³ 10 æ¬¡å¾Œç„¡æ³•å†ç²å¾—é»æ•¸
- [ ] æ¸¬è©¦æŸ¥è©¢ 20 æ¬¡å¾Œç„¡æ³•å†ç²å¾—é»æ•¸
- [ ] æ¸¬è©¦çµ¦è®š 5 æ¬¡å¾Œç„¡æ³•å†ç²å¾—é»æ•¸
- [ ] æ¸¬è©¦æ¯æ—¥ç™»å…¥åªèƒ½ç²å¾— 1 æ¬¡é»æ•¸

### æ¸¬è©¦ 3ï¼šç­‰ç´šå‡ç´š
- [ ] æ¸¬è©¦ç´¯ç© 150 é»å¾Œå‡ç´šåˆ° LV2
- [ ] æ¸¬è©¦å‡ç´šå¾Œç¨±è™Ÿå’Œé¡è‰²æ›´æ–°
- [ ] æ¸¬è©¦å‡ç´šå¾Œé…é¡çå‹µæ­£ç¢ºç´¯åŠ 

### æ¸¬è©¦ 4ï¼šå‹³ç« è§£é–
- [ ] æ¸¬è©¦é¦–æ¬¡ä¸Šå‚³å¾Œè§£é–ã€Œé¦–æ¬¡ä¸Šå‚³ã€å‹³ç« 
- [ ] æ¸¬è©¦é¦–æ¬¡æŸ¥è©¢å¾Œè§£é–ã€Œé¦–æ¬¡æŸ¥è©¢ã€å‹³ç« 
- [ ] æ¸¬è©¦é€£çºŒç™»å…¥ 7 å¤©å¾Œè§£é–ã€Œé€£çºŒç™»å…¥ 7 å¤©ã€å‹³ç« 

---

## ğŸ“Š é ä¼°æ™‚é–“åˆ†é…

| æ­¥é©Ÿ | é ä¼°æ™‚é–“ | ç´¯è¨ˆæ™‚é–“ |
|------|---------|---------|
| æ­¥é©Ÿ 1ï¼šæ´»èºåº¦é»æ•¸è¨ˆç®— API | 30 åˆ†é˜ | 30 åˆ†é˜ |
| æ­¥é©Ÿ 2ï¼šç­‰ç´šå‡ç´šæª¢æŸ¥ API | 20 åˆ†é˜ | 50 åˆ†é˜ |
| æ­¥é©Ÿ 3ï¼šå‹³ç« è§£é–æª¢æŸ¥ API | 40 åˆ†é˜ | 1.5 å°æ™‚ |
| æ­¥é©Ÿ 4ï¼šæŒ‰è®šåŠŸèƒ½ API | 30 åˆ†é˜ | 2 å°æ™‚ |
| æ­¥é©Ÿ 5ï¼šæ•´åˆåˆ°ä¸Šå‚³ API | 10 åˆ†é˜ | 2.2 å°æ™‚ |
| æ­¥é©Ÿ 6ï¼šæ•´åˆåˆ°æŸ¥è©¢ API | 10 åˆ†é˜ | 2.3 å°æ™‚ |
| æ­¥é©Ÿ 7ï¼šæ•´åˆåˆ°ç™»å…¥ API | 15 åˆ†é˜ | 2.5 å°æ™‚ |
| æ¸¬è©¦èˆ‡é™¤éŒ¯ | 1.5 å°æ™‚ | 4 å°æ™‚ |
| **ç¸½è¨ˆ** | **4 å°æ™‚** | **0.5 å¤©** |

---

## ğŸ”„ ä¸‹ä¸€æ­¥

å®Œæˆéšæ®µ G.2 å¾Œï¼Œç¹¼çºŒåŸ·è¡Œï¼š

**éšæ®µ G.3ï¼šç­‰ç´šå‡ç´šè§¸ç™¼**ï¼ˆé ä¼° 1 å¤©ï¼‰
- å»ºç«‹å‡ç´šé€šçŸ¥çµ„ä»¶
- æ•´åˆåˆ°å‰ç«¯é é¢
- æ¸¬è©¦å‡ç´šæµç¨‹

---

**æ–‡ä»¶çµæŸ**

