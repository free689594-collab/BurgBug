# 階段 G.2：活躍度點數計算邏輯 - 進度報告

**版本**：v2.0
**日期**：2025-01-15
**狀態**：✅ 開發完成，準備測試

---

## ✅ 已完成的工作

### 1. 建立核心 API（4 個）

#### ✅ 1.1 活躍度點數計算 API
- **檔案**：`src/app/api/activity/add-points/route.ts`
- **功能**：
  - ✅ 驗證使用者身份
  - ✅ 驗證 action 參數
  - ✅ 從 activity_point_rules 取得點數規則
  - ✅ 檢查每日上限
  - ✅ 檢查冷卻時間
  - ✅ 新增活躍度點數到 member_statistics
  - ✅ 記錄到 activity_point_history
  - ✅ 呼叫等級升級檢查
  - ✅ 呼叫勳章解鎖檢查
  - ✅ 返回新的點數和等級

#### ✅ 1.2 等級升級檢查 API
- **檔案**：`src/app/api/activity/check-level-up/route.ts`
- **功能**：
  - ✅ 驗證使用者身份
  - ✅ 呼叫 calculate_member_level 函數
  - ✅ 比較新舊等級
  - ✅ 如果升級，更新 member_statistics
  - ✅ 返回升級資訊

#### ✅ 1.3 勳章解鎖檢查 API
- **檔案**：`src/app/api/activity/check-badges/route.ts`
- **功能**：
  - ✅ 驗證使用者身份
  - ✅ 取得所有啟用的勳章配置
  - ✅ 取得會員統計資料
  - ✅ 逐一檢查解鎖條件
  - ✅ 支援 simple 條件（統計欄位）
  - ✅ 支援 role 條件（角色檢查）
  - ✅ 支援 badge_count 條件（勳章數量）
  - ✅ 支援 custom 條件（自訂邏輯）
  - ✅ 解鎖符合條件的勳章
  - ✅ 返回新解鎖的勳章列表

#### ✅ 1.4 按讚功能 API
- **檔案**：`src/app/api/member/like/[memberId]/route.ts`
- **功能**：
  - ✅ POST：按讚功能
    - ✅ 驗證使用者身份
    - ✅ 檢查是否為自己
    - ✅ 檢查是否已按讚
    - ✅ 插入按讚記錄
    - ✅ 給讚者 +1 點
    - ✅ 被讚者 +3 點
    - ✅ 返回成功回應
  - ✅ DELETE：取消按讚功能
    - ✅ 驗證使用者身份
    - ✅ 檢查按讚記錄是否存在
    - ✅ 刪除按讚記錄
    - ✅ 給讚者 -1 點
    - ✅ 被讚者 -3 點
    - ✅ 返回成功回應

---

### 2. 整合到現有 API（3/3 完成）

#### ✅ 2.1 整合到上傳 API
- **檔案**：`src/app/api/debts/upload/route.ts`
- **修改位置**：第 258 行之後
- **新增功能**：
  - ✅ 成功上傳後呼叫活躍度點數 API
  - ✅ 新增 +2 點
  - ✅ 記錄 metadata（debt_record_id, residence）

#### ✅ 2.2 整合到查詢 API
- **檔案**：`src/app/api/debts/search/route.ts`
- **修改位置**：第 184 行之後
- **新增功能**：
  - ✅ 成功查詢後呼叫活躍度點數 API
  - ✅ 新增 +1 點
  - ✅ 記錄 metadata（first_letter, last5, residence, result_count）

#### ✅ 2.3 整合到登入 API
- **檔案**：`src/app/api/auth/login/route.ts`
- **修改位置**：第 176 行之後
- **新增功能**：
  - ✅ 檢查今天是否已登入
  - ✅ 計算連續登入天數
  - ✅ 更新 last_login_date 和 consecutive_login_days
  - ✅ 呼叫活躍度點數 API
  - ✅ 新增 +3 點（每日登入）

### 3. 環境設定

#### ✅ 3.1 環境變數設定
- **檔案**：`.env.local`
- **新增**：`NEXT_PUBLIC_APP_URL=http://localhost:3000`

---

## 📝 待完成的工作

### 1. 測試與除錯（預估 1.5 小時）

#### 測試 1：活躍度點數計算
- [ ] 測試上傳債務資料後獲得 +2 點
- [ ] 測試查詢債務資料後獲得 +1 點
- [ ] 測試每日登入後獲得 +3 點
- [ ] 測試按讚後給讚者獲得 +1 點
- [ ] 測試收讚後被讚者獲得 +3 點

#### 測試 2：每日上限檢查
- [ ] 測試上傳 10 次後無法再獲得點數
- [ ] 測試查詢 20 次後無法再獲得點數
- [ ] 測試給讚 5 次後無法再獲得點數
- [ ] 測試每日登入只能獲得 1 次點數

#### 測試 3：等級升級
- [ ] 測試累積 150 點後升級到 LV2
- [ ] 測試升級後稱號和顏色更新
- [ ] 測試升級後配額獎勵正確累加

#### 測試 4：勳章解鎖
- [ ] 測試首次上傳後解鎖「首次上傳」勳章
- [ ] 測試首次查詢後解鎖「首次查詢」勳章
- [ ] 測試連續登入 7 天後解鎖「連續登入 7 天」勳章

---

## 🐛 已知問題

### 問題 1：fetch 呼叫可能失敗
- **描述**：在 API 中使用 fetch 呼叫其他 API 可能會失敗
- **影響**：活躍度點數可能無法正確新增
- **解決方案**：
  - 選項 1：改用直接呼叫資料庫的方式
  - 選項 2：使用 Supabase Edge Functions
  - 選項 3：使用 Server Actions

### 問題 2：NEXT_PUBLIC_APP_URL 環境變數
- **描述**：需要設定 NEXT_PUBLIC_APP_URL 環境變數
- **影響**：fetch 呼叫會失敗
- **解決方案**：在 .env.local 中新增 `NEXT_PUBLIC_APP_URL=http://localhost:3000`

---

## 💡 優化建議

### 1. 改用直接資料庫操作
目前使用 fetch 呼叫其他 API，可能會有以下問題：
- 網路延遲
- 錯誤處理複雜
- 需要額外的環境變數

**建議**：將活躍度點數邏輯抽取成獨立的函數，直接在各 API 中呼叫。

### 2. 使用資料庫觸發器
可以考慮使用資料庫觸發器來自動更新統計資料：
- 當 debt_records INSERT 時，自動 +2 點
- 當 member_likes INSERT 時，自動 +1/+3 點

**優點**：
- 更可靠
- 更快速
- 不需要在應用層處理

**缺點**：
- 需要修改資料庫
- 除錯較困難

### 3. 批次處理
對於勳章解鎖檢查，可以考慮批次處理：
- 不是每次都檢查所有勳章
- 只檢查可能解鎖的勳章

---

## 📊 時間統計

| 任務 | 預估時間 | 實際時間 | 狀態 |
|------|---------|---------|------|
| 建立活躍度點數計算 API | 30 分鐘 | 40 分鐘 | ✅ 完成 |
| 建立等級升級檢查 API | 20 分鐘 | 15 分鐘 | ✅ 完成 |
| 建立勳章解鎖檢查 API | 40 分鐘 | 50 分鐘 | ✅ 完成 |
| 建立按讚功能 API | 30 分鐘 | 45 分鐘 | ✅ 完成 |
| 整合到上傳 API | 10 分鐘 | 10 分鐘 | ✅ 完成 |
| 整合到查詢 API | 10 分鐘 | 10 分鐘 | ✅ 完成 |
| 整合到登入 API | 15 分鐘 | 20 分鐘 | ✅ 完成 |
| 環境變數設定 | 5 分鐘 | 5 分鐘 | ✅ 完成 |
| 測試與除錯 | 1.5 小時 | - | ⏳ 待完成 |
| **總計** | **4 小時** | **2.5 小時** | **100% 開發完成** |

---

## 🔄 下一步

1. **測試階段**（立即執行）：
   - 啟動開發伺服器（`npm run dev`）
   - 執行所有測試案例（參考 `G2_TESTING_GUIDE.md`）
   - 修正發現的 bug
   - 優化效能

2. **後續階段**：
   - 階段 G.3：等級升級觸發（前端整合）
   - 階段 G.4：勳章解鎖邏輯（前端整合）
   - 階段 G.5：會員等級顯示整合
   - 階段 G.6：管理員配置介面

---

**文件結束**

