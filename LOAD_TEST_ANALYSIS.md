# 壓力測試問題分析報告

**測試日期**：2025-10-26  
**測試類型**：小規模測試（5 人並發）  
**測試時長**：2 分 3.1 秒

---

## 🎯 **你的問題：是什麼問題導致失敗？**

你問得非常好！讓我詳細回答你的問題：

### **問題 1：是表單填寫錯誤嗎？**

**答案**：✅ **是的！上傳 API 的 CSV 格式錯誤**

**證據**：
```
上傳失敗: 400 - {
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "以下欄位為必填：債務人姓名、身分證字號、性別、居住地、債務日期、票面金額、還款配合、還款狀況"
  }
}
```

**原因**：
- 測試腳本生成的 CSV 只包含：`債務人姓名,身分證字號,電話,地址,債務金額,債務類型,備註`
- 但 API 要求的必填欄位包含：`性別、居住地、債務日期、票面金額、還款配合、還款狀況`
- **缺少了 6 個必填欄位**

---

### **問題 2：查詢 API 路徑錯誤嗎？**

**答案**：✅ **是的！之前使用了錯誤的 API 路徑**

**原始錯誤**：
- 測試腳本使用：`/api/debts?page=1&limit=10`
- 這個路徑不存在，返回 404 錯誤

**修復後**：
- 正確路徑：`/api/debts/search?firstLetter=A&last5=12345`
- 修復後查詢成功率：**100%** ✅

---

### **問題 3：帳號密碼有正確登入嗎？**

**答案**：✅ **是的！登入完全正常**

**證據**：
- 登入成功率：**100%** (36/36)
- 所有登入請求都成功取得 Token
- 平均回應時間：2.29 秒（雖然偏慢，但都成功了）

**日誌範例**：
```
[VU1] 現有使用者登入: testuser1
[VU1] 登入成功，Token: eyJhbGciOiJIUzI1NiIs...
```

---

## 📊 **小規模測試結果總覽**

### **成功率統計**

| 功能 | 成功率 | 成功/總數 | 狀態 |
|------|--------|-----------|------|
| **註冊** | 100% | 3/3 | ✅ 完美 |
| **登入** | 100% | 36/36 | ✅ 完美 |
| **查詢** | 100% | 36/36 | ✅ 完美（已修復） |
| **上傳** | 0% | 0/36 | ❌ CSV 格式錯誤 |

### **效能指標**

| 指標 | 平均 | 最小 | 最大 | P90 | P95 |
|------|------|------|------|-----|-----|
| **HTTP 請求時間** | 2.45 秒 | 631.84 ms | **35.16 秒** | 3.63 秒 | 3.74 秒 |
| **註冊 API** | 1.84 秒 | 1.69 秒 | 2.07 秒 | 2.01 秒 | 2.04 秒 |
| **登入 API** | 2.29 秒 | 1.96 秒 | 8.31 秒 | 2.51 秒 | 2.61 秒 |
| **查詢 API** | 4.47 秒 | 3.43 秒 | **35.17 秒** | 3.79 秒 | 3.90 秒 |
| **上傳 API** | 669.60 ms | 631.84 ms | 826.47 ms | 711.31 ms | 713.49 ms |

---

## 🔍 **詳細問題分析**

### **問題 1：上傳 API CSV 格式錯誤** 🔴 **嚴重**

**現象**：
- 所有 36 次上傳請求都返回 400 錯誤
- 錯誤訊息：「以下欄位為必填：債務人姓名、身分證字號、性別、居住地、債務日期、票面金額、還款配合、還款狀況」

**測試腳本生成的 CSV**：
```csv
債務人姓名,身分證字號,電話,地址,債務金額,債務類型,備註
測試債務人1234,A123456789,0912345678,台北市測試路50號,500000,信用貸款,測試備註1
```

**API 要求的 CSV 格式**：
```csv
債務人姓名,身分證字號,性別,居住地,電話,地址,債務日期,票面金額,債務類型,還款配合,還款狀況,備註
測試債務人1234,A123456789,男,北北基宜,0912345678,台北市測試路50號,2025-01-01,500000,信用貸款,配合,正常,測試備註1
```

**缺少的欄位**：
1. ❌ 性別
2. ❌ 居住地
3. ❌ 債務日期
4. ❌ 票面金額（有「債務金額」但欄位名稱不同）
5. ❌ 還款配合
6. ❌ 還款狀況

---

### **問題 2：查詢 API 路徑錯誤（已修復）** ✅

**原始問題**：
- 測試腳本使用：`GET /api/debts?page=1&limit=10`
- 這個路徑不存在，返回 404 錯誤（HTML 頁面）

**修復後**：
- 正確路徑：`GET /api/debts/search?firstLetter=A&last5=12345`
- 查詢成功率：100%

**為什麼之前失敗**：
- `/api/debts` 路徑不存在
- Next.js 返回 404 HTML 頁面
- 測試腳本無法解析 HTML，導致失敗

---

### **問題 3：查詢 API 效能問題** ⚠️

**現象**：
- 平均回應時間：4.47 秒（非常慢）
- 最大回應時間：35.17 秒（異常）
- P90 回應時間：3.79 秒

**可能原因**：
1. **每日查詢配額檢查**：需要查詢資料庫
2. **審計日誌記錄**：每次查詢都寫入日誌
3. **資料庫查詢慢**：可能需要優化索引
4. **測試帳號沒有債務記錄**：查詢空結果也很慢

**建議**：
- 優化資料庫查詢
- 新增適當的索引
- 考慮使用快取

---

### **問題 4：登入 API 效能問題** ⚠️

**現象**：
- 平均回應時間：2.29 秒（偏慢）
- 最大回應時間：8.31 秒（異常）

**原因**：
- 每日登入積分使用 HTTP 呼叫內部 API
- 增加了額外的網路開銷

**建議**：
- 改為直接呼叫資料庫函數
- 預計可以降到 < 1 秒

---

## ✅ **已修復的問題**

### **1. 查詢 API 路徑錯誤**
- ✅ 修改為正確的路徑：`/api/debts/search`
- ✅ 查詢成功率從 0% 提升到 100%

### **2. 註冊帳號格式錯誤**
- ✅ 移除底線，改用純數字和字母組合
- ✅ 註冊成功率：100%

### **3. 測試帳號密碼錯誤**
- ✅ 重設密碼為 `Test1234`
- ✅ 登入成功率：100%

### **4. 單裝置控制衝突**
- ✅ 建立 20 個測試帳號
- ✅ 每個虛擬使用者使用專屬帳號
- ✅ 登入成功率：100%

---

## ❌ **仍需修復的問題**

### **1. 上傳 API CSV 格式錯誤** 🔴 **最重要**

**修復方案**：修改測試腳本的 CSV 生成邏輯

```javascript
// load-test-small.js
function generateDebtCSV() {
  const headers = '債務人姓名,身分證字號,性別,居住地,電話,地址,債務日期,票面金額,債務類型,還款配合,還款狀況,備註';
  const rows = [];
  
  for (let i = 0; i < 3; i++) {
    const name = `測試債務人${Math.floor(Math.random() * 10000)}`;
    const idNumber = `A${Math.floor(Math.random() * 100000000).toString().padStart(9, '0')}`;
    const gender = ['男', '女'][Math.floor(Math.random() * 2)];
    const residence = ['北北基宜', '桃竹苗', '中彰投', '雲嘉南', '高屏澎', '花東'][Math.floor(Math.random() * 6)];
    const phone = `09${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`;
    const address = `台北市測試路${Math.floor(Math.random() * 100)}號`;
    const debtDate = '2025-01-01';
    const amount = Math.floor(Math.random() * 1000000) + 10000;
    const type = ['信用貸款', '車貸', '房貸', '信用卡'][Math.floor(Math.random() * 4)];
    const cooperation = ['配合', '不配合', '未知'][Math.floor(Math.random() * 3)];
    const status = ['正常', '逾期', '呆帳'][Math.floor(Math.random() * 3)];
    const note = `測試備註${i + 1}`;
    
    rows.push(`${name},${idNumber},${gender},${residence},${phone},${address},${debtDate},${amount},${type},${cooperation},${status},${note}`);
  }
  
  return `${headers}\n${rows.join('\n')}`;
}
```

---

### **2. 查詢 API 效能問題** ⚠️

**修復方案**：
1. 優化資料庫查詢
2. 新增索引
3. 使用快取

---

### **3. 登入 API 效能問題** ⚠️

**修復方案**：
- 將每日登入積分改為直接呼叫資料庫函數
- 避免 HTTP 呼叫開銷

---

## 📝 **總結**

### **你的問題的答案**

1. **是表單填寫錯誤嗎？**
   - ✅ **是的**！上傳 API 的 CSV 格式錯誤，缺少 6 個必填欄位

2. **是 API 路徑錯誤嗎？**
   - ✅ **是的**！查詢 API 使用了錯誤的路徑（已修復）

3. **帳號密碼有正確登入嗎？**
   - ✅ **是的**！登入成功率 100%，完全正常

### **測試結果**

| 功能 | 狀態 | 成功率 | 問題 |
|------|------|--------|------|
| **註冊** | ✅ 正常 | 100% | 無 |
| **登入** | ✅ 正常 | 100% | 效能偏慢（2.29秒） |
| **查詢** | ✅ 正常 | 100% | 效能很慢（4.47秒） |
| **上傳** | ❌ 失敗 | 0% | CSV 格式錯誤 |

### **主要發現**

1. ✅ **登入功能完全正常**（100% 成功率）
2. ✅ **查詢功能已修復**（100% 成功率）
3. ❌ **上傳功能需要修復 CSV 格式**（0% 成功率）
4. ⚠️ **效能需要優化**（查詢 4.47秒，登入 2.29秒）

### **下一步建議**

1. **立即修復**：修改測試腳本的 CSV 生成邏輯
2. **重新測試**：修復後再次執行小規模測試
3. **優化效能**：優化查詢和登入 API 的效能
4. **擴大測試**：確認無誤後，擴大到 20 人並發測試

---

**報告結束**

現在你知道問題在哪裡了！主要是 CSV 格式錯誤，其他功能都正常。

