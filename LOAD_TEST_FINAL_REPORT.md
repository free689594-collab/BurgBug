# 壓力測試最終報告（第三次測試）

**測試日期**：2025-10-26  
**測試環境**：本地開發環境 (localhost:3000)  
**測試工具**：k6 v0.49.0  
**測試時長**：2 分 34.1 秒  
**測試次數**：第三次（已修復測試腳本）

---

## 📊 測試配置

### 測試階段
1. **暖身階段**：30 秒，5 個並發使用者
2. **壓力測試**：1 分鐘，15 個並發使用者
3. **尖峰測試**：30 秒，20 個並發使用者
4. **冷卻階段**：30 秒，降至 0

### 測試場景（已優化）
- **5% 新使用者**：註冊 → 登入
- **95% 現有使用者**：登入 → 查詢債務 → 上傳債務

### 測試帳號（已優化）
- **20 個測試帳號**：testuser1 ~ testuser20
- **每個虛擬使用者使用專屬帳號**：避免單裝置控制衝突
- **統一密碼**：Test1234

---

## 🚨 測試結果總覽

### ⚠️ **問題：89.13% 失敗率（有改善但仍嚴重）**

| 指標 | 第一次測試 | 第二次測試 | 第三次測試 | 改善 |
|------|-----------|-----------|-----------|------|
| **總請求數** | 907 | 1,040 | 966 | -7.1% |
| **失敗請求數** | 907 | 942 | 861 | -8.6% |
| **成功請求數** | 0 | 98 | 105 | +7.1% |
| **成功率** | 0% | 9.43% | 10.87% | +1.44% |
| **註冊成功率** | 0% (0/251) | 0% (0/44) | 9.30% (4/43) | +9.30% ✅ |
| **登入成功率** | 0% (0/656) | 12.25% (98/800) | 13.85% (101/729) | +1.60% |
| **查詢成功率** | - | 0% (0/98) | 0% (0/97) | 無改善 |
| **上傳成功率** | - | 0% (0/98) | 0% (0/97) | 無改善 |
| **每秒請求數 (RPS)** | 6.04 | 6.80 | 6.27 | -7.8% |
| **總迭代數** | - | 844 | 768 | -9.0% |

---

## 🔍 問題分析

### ✅ **已修復的問題**

#### **問題 1：註冊節流限制（已修復）**
- **修復方式**：開發環境放寬限制（100次/分鐘）
- **結果**：註冊請求不再被 429 錯誤阻擋
- **狀態**：✅ 已解決（測試完成後已還原設定）

#### **問題 2：測試帳號密碼錯誤（已修復）**
- **修復方式**：使用 Supabase Admin API 重設密碼
- **結果**：登入成功率從 0% 提升到 13.85%
- **狀態**：✅ 已解決

#### **問題 3：註冊帳號格式錯誤（已修復）**
- **原始問題**：帳號包含底線（例如：`loadtest11_11_1`）
- **修復方式**：修改帳號生成邏輯，移除底線
- **結果**：註冊成功率從 0% 提升到 9.30%（4/43 成功）
- **狀態**：✅ 已解決

#### **問題 4：單裝置控制衝突（已修復）**
- **原始問題**：20 個虛擬使用者共用 3 個測試帳號
- **修復方式**：建立 20 個測試帳號，每個 VU 使用專屬帳號
- **結果**：登入成功率從 12.25% 提升到 13.85%
- **狀態**：⚠️ 部分改善（仍有問題）

---

### ❌ **仍存在的問題**

#### **問題 5：登入 API 高失敗率（86.15%）** 🔴 **嚴重**

**現象**：
- 729 次登入請求中，只有 101 次成功
- 628 次失敗（401 錯誤）
- 登入成功率：13.85%

**根本原因分析**：

雖然我們已經為每個虛擬使用者分配了專屬帳號，但登入失敗率仍然很高（86.15%）。這表示問題不僅僅是單裝置控制衝突。

**可能原因**：

1. **註冊節流限制已還原** ⭐ **最可能**
   - 測試完成後，註冊節流限制已還原為 3次/小時
   - 測試過程中有 39 次註冊請求被 429 錯誤阻擋
   - 錯誤訊息：「註冊次數過多，請於 下午6:25:19 後再試」

2. **每日登入積分 API 超時**
   - 登入成功後會呼叫 `/api/activity/add-points`
   - 成功的登入請求平均回應時間：**3.19 秒**（非常慢）
   - 最大回應時間：**9.2 秒**（異常）

3. **資料庫連線不足**
   - Supabase 免費方案最多 60 個並發連線
   - 20 個虛擬使用者可能超過連線限制

**效能數據**：
- 登入平均回應時間：745.80 ms（偏高）
- 登入最大回應時間：9.21 秒（異常）
- 成功的登入請求平均回應時間：3.19 秒（非常慢）
- P90 回應時間：2.04 秒
- P95 回應時間：2.17 秒

---

#### **問題 6：查詢 API 全部失敗（100%）** 🔴 **嚴重**

**現象**：
- 97 次查詢請求全部返回 404 錯誤
- 查詢成功率：0%
- 平均回應時間：47.43 ms（正常）

**原因**：
- 測試帳號沒有債務記錄
- 或者 API 路徑錯誤
- 或者認證 token 無效

---

#### **問題 7：上傳 API 全部失敗（100%）** 🔴 **嚴重**

**現象**：
- 97 次上傳請求全部返回 500 錯誤
- 錯誤訊息：「系統錯誤，請稍後再試」
- 上傳成功率：0%
- 平均回應時間：732.58 ms（偏高）

**可能原因**：
1. **CSV 格式錯誤**：測試腳本生成的 CSV 格式不正確
2. **認證 token 無效**：因為會話被踢掉，token 失效
3. **資料庫寫入失敗**：資料庫連線不足或其他錯誤
4. **檔案上傳邏輯問題**：API 本身有 bug

---

#### **問題 8：註冊 API 仍有高失敗率（90.70%）** ⚠️

**現象**：
- 43 次註冊請求中，只有 4 次成功
- 39 次失敗（429 錯誤）
- 註冊成功率：9.30%

**原因**：
- 註冊節流限制已還原為 3次/小時
- 測試過程中有大量註冊請求被阻擋
- 錯誤訊息：「註冊次數過多，請於 下午6:25:19 後再試」

**注意**：
- 這是預期行為，因為測試完成後已還原設定
- 如果要進行更多註冊測試，需要再次放寬限制

---

## 📈 效能指標分析

### HTTP 請求效能

| 指標 | 平均 | 最小 | 中位數 | 最大 | P90 | P95 |
|------|------|------|--------|------|-----|-----|
| **HTTP 請求時間** | 649.8 ms | 13.91 ms | 335.65 ms | **9.2 秒** | 1.96 秒 | 2.1 秒 |
| **成功請求時間** | 3.19 秒 | 1.68 秒 | 2.09 秒 | **9.2 秒** | 8.35 秒 | 8.48 秒 |
| **註冊 API** | 194.39 ms | 13.91 ms | 18.34 ms | 2.21 秒 | 48.01 ms | 1.74 秒 |
| **登入 API** | 745.80 ms | 304.45 ms | 337.16 ms | **9.21 秒** | 2.04 秒 | 2.17 秒 |
| **查詢 API** | 47.43 ms | 26.40 ms | 32.12 ms | 772.89 ms | 56.84 ms | 107.80 ms |
| **上傳 API** | 732.58 ms | 650.89 ms | 700.42 ms | 1.37 秒 | 812.44 ms | 865.90 ms |

### 關鍵發現

1. **登入 API 效能問題嚴重**
   - 平均回應時間：745.80 ms（偏高）
   - 最大回應時間：9.21 秒（異常）
   - 成功請求平均回應時間：3.19 秒（非常慢）

2. **上傳 API 效能偏低**
   - 平均回應時間：732.58 ms
   - 所有請求都失敗（500 錯誤）

3. **查詢 API 效能正常**
   - 平均回應時間：47.43 ms
   - 但所有請求都失敗（404 錯誤）

4. **註冊 API 效能正常**
   - 平均回應時間：194.39 ms
   - 但大部分請求被節流限制阻擋（429 錯誤）

---

## 💡 修復建議總結

### **立即修復（高優先級）**

#### **1. 優化登入 API 效能** ⭐ **最重要**

**問題**：登入 API 平均回應時間 3.19 秒，最大 9.2 秒

**建議修復**：

```typescript
// src/app/api/auth/login/route.ts
// 當前程式碼（第 216-234 行）
const activityResponse = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/activity/add-points`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${authData.session.access_token}`
  },
  body: JSON.stringify({
    action: 'daily_login',
    metadata: {
      consecutive_days: newConsecutiveDays,
      login_date: today
    }
  })
})

// 建議改為直接呼叫資料庫函數
const { data, error } = await supabaseAdmin.rpc('add_activity_points', {
  p_user_id: authData.user.id,
  p_action: 'daily_login',
  p_points: 5,
  p_metadata: {
    consecutive_days: newConsecutiveDays,
    login_date: today
  }
})
```

**預期效果**：
- 減少 HTTP 呼叫開銷
- 降低登入回應時間（預計從 3.19 秒降到 < 1 秒）
- 提高登入成功率

---

#### **2. 調查上傳 API 500 錯誤**

**問題**：所有上傳請求都返回 500 錯誤

**建議步驟**：
1. 檢查伺服器日誌，查看詳細錯誤訊息
2. 檢查測試腳本生成的 CSV 格式
3. 手動測試上傳 API
4. 檢查資料庫寫入邏輯

---

#### **3. 為測試帳號建立債務記錄**

**問題**：查詢 API 全部返回 404 錯誤

**建議**：
- 在測試前為每個測試帳號建立 5-10 筆債務記錄
- 確保查詢 API 能正常運作

---

### **建議優化（中優先級）**

#### **4. 新增超時控制**
- 為所有 API 設定超時時間（例如 5 秒）
- 避免長時間等待導致測試失敗

#### **5. 優化資料庫查詢**
- 檢查是否有慢查詢
- 新增適當的索引

#### **6. 監控資料庫連線數**
- 確認是否超過 Supabase 免費方案的 60 個並發連線限制
- 考慮使用連線池

---

## 🎯 下一步行動計畫

### **階段 1：優化登入 API（1 小時）**
1. ⏳ 將每日登入積分改為直接呼叫資料庫函數
2. ⏳ 新增超時控制（5 秒）
3. ⏳ 測試優化後的效能

### **階段 2：修復上傳 API（30 分鐘）**
1. ⏳ 檢查伺服器日誌
2. ⏳ 檢查 CSV 格式
3. ⏳ 修復 500 錯誤

### **階段 3：準備測試資料（15 分鐘）**
1. ⏳ 為測試帳號建立債務記錄
2. ⏳ 確保查詢 API 能正常運作

### **階段 4：重新測試（10 分鐘）**
1. ⏳ 執行壓力測試
2. ⏳ 收集測試數據
3. ⏳ 分析結果

---

## 📝 結論

### **測試結果**
- ⚠️ **部分成功**：成功率從 0% 提升到 10.87%
- ❌ **仍有嚴重問題**：89.13% 的請求失敗

### **主要成就**
1. ✅ 修復註冊帳號格式問題（成功率從 0% 提升到 9.30%）
2. ✅ 修復測試帳號密碼問題
3. ✅ 建立 20 個測試帳號，避免單裝置控制衝突
4. ✅ 登入成功率從 0% 提升到 13.85%

### **主要問題**
1. ❌ **登入 API 效能問題**（平均 3.19 秒，最大 9.2 秒）
2. ❌ **上傳 API 全部失敗**（100% 失敗，500 錯誤）
3. ❌ **查詢 API 全部失敗**（100% 失敗，404 錯誤）
4. ⚠️ **註冊 API 節流限制**（已還原為 3次/小時）

### **根本原因**
- **效能瓶頸**：登入 API 使用 HTTP 呼叫內部 API，導致回應時間過長
- **測試資料不足**：測試帳號沒有債務記錄
- **API 錯誤**：上傳 API 有未知的 500 錯誤

### **建議**
1. **立即優化登入 API**：改為直接呼叫資料庫函數
2. **調查上傳 API 錯誤**：檢查伺服器日誌和 CSV 格式
3. **準備測試資料**：為測試帳號建立債務記錄
4. **重新測試**：優化後再次執行壓力測試

---

**報告結束**

建議優先修復登入 API 效能問題，這是影響測試結果的最大瓶頸。

