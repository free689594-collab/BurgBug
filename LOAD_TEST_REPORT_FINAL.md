# 壓力測試最終報告

**測試日期**：2025-10-26  
**測試環境**：本地開發環境 (localhost:3000)  
**測試工具**：k6 v0.49.0  
**測試時長**：2 分 32.9 秒  
**測試次數**：第二次（已修復部分問題）

---

## 📊 測試配置

### 測試階段
1. **暖身階段**：30 秒，5 個並發使用者
2. **壓力測試**：1 分鐘，15 個並發使用者
3. **尖峰測試**：30 秒，20 個並發使用者
4. **冷卻階段**：30 秒，降至 0

### 測試場景（已優化）
- **5% 新使用者**：註冊 → 登入（從 30% 降低以避免節流限制）
- **95% 現有使用者**：登入 → 查詢債務 → 上傳債務

### 測試帳號
- testuser1 (密碼: Test1234) ✅ 已重設密碼
- testuser2 (密碼: Test1234) ✅ 已重設密碼
- testuser3 (密碼: Test1234) ✅ 已重設密碼

---

## 🚨 測試結果總覽

### ⚠️ **問題：90.57% 失敗率（有改善但仍嚴重）**

| 指標 | 第一次測試 | 第二次測試 | 改善 |
|------|-----------|-----------|------|
| **總請求數** | 907 | 1,040 | +14.7% |
| **失敗請求數** | 907 | 942 | +3.9% |
| **成功請求數** | 0 | 98 | ✅ |
| **成功率** | 0% | 9.43% | +9.43% |
| **註冊成功率** | 0% (0/251) | 0% (0/44) | 無改善 |
| **登入成功率** | 0% (0/656) | 12.25% (98/800) | +12.25% |
| **查詢成功率** | - | 0% (0/98) | - |
| **上傳成功率** | - | 0% (0/98) | - |
| **每秒請求數 (RPS)** | 6.04 | 6.80 | +12.6% |

---

## 🔍 問題分析

### ✅ **已修復的問題**

#### **問題 1：註冊節流限制（已修復）**
- **原始問題**：每小時只允許 3 次註冊（每個 IP）
- **修復方式**：開發環境放寬限制（100次/分鐘）
- **程式碼修改**：
```typescript
// src/app/api/auth/register/route.ts
const RATE_LIMIT = {
  MAX_ATTEMPTS: process.env.NODE_ENV === 'production' ? 3 : 100,
  WINDOW_MS: process.env.NODE_ENV === 'production' ? 60 * 60 * 1000 : 60 * 1000,
}
```
- **結果**：註冊請求不再被 429 錯誤阻擋
- **狀態**：✅ 已解決

#### **問題 2：測試帳號密碼錯誤（已修復）**
- **原始問題**：測試帳號密碼無法登入
- **修復方式**：使用 Supabase Admin API 重設密碼
- **結果**：登入成功率從 0% 提升到 12.25%
- **狀態**：⚠️ 部分改善，但仍有問題

---

### ❌ **新發現的問題**

#### **問題 3：註冊帳號格式驗證失敗** 🔴 **嚴重**

**現象**：
- 所有 44 次註冊請求都返回 400 錯誤
- 錯誤訊息：「帳號格式錯誤：僅允許英文字母和數字，長度 5-15 字元」

**原因**：
- 測試腳本生成的帳號格式：`loadtest{VU}_{iteration}_{timestamp}`
- 例如：`loadtest11_11_1`、`loadtest16_30_1`
- 這些帳號包含底線 `_`，不符合格式要求（僅允許英文字母和數字）

**影響**：
- 44 次註冊請求全部失敗
- 註冊成功率：0%
- 無法測試新使用者註冊流程

**修復建議**：
```javascript
// load-test.js - 修改帳號生成邏輯
const timestamp = Date.now().toString().slice(-6) // 取最後 6 位數
const account = `test${vuId}${iteration}${timestamp}` // 移除 "loadtest" 前綴和底線
// 例如：test1101234567（符合 5-15 字元，僅英文字母和數字）
```

---

#### **問題 4：登入 API 高失敗率（87.75%）** 🔴 **嚴重**

**現象**：
- 800 次登入請求中，只有 98 次成功
- 702 次失敗（401 錯誤）
- 登入成功率：12.25%

**根本原因：單裝置控制衝突** ⭐ **最可能**

系統有單裝置控制機制（`active_sessions` 表），當多個虛擬使用者同時使用同一個帳號登入時：
1. 第一個登入成功，建立會話
2. 第二個登入時，會踢掉第一個會話
3. 第一個使用者的後續請求會因為會話無效而失敗（401）
4. 循環往復，導致大部分請求失敗

**證據**：
- 只有 3 個測試帳號，但有 20 個虛擬使用者
- 平均每個帳號被 6-7 個虛擬使用者同時使用
- 會話不斷被踢掉，導致高失敗率

**其他可能原因**：

**原因 B：每日登入積分 API 超時**
- 登入成功後會呼叫 `/api/activity/add-points`
- 這個 HTTP 呼叫可能超時或失敗
- 導致整個登入流程失敗

**原因 C：資料庫連線不足**
- Supabase 免費方案最多 60 個並發連線
- 20 個虛擬使用者可能超過連線限制

**效能數據**：
- 登入平均回應時間：582 ms（偏高）
- 登入最大回應時間：9.51 秒（異常）
- 成功的登入請求平均回應時間：2.26 秒（非常慢）

**修復建議**：
1. **增加測試帳號數量**：建立 20 個測試帳號（testuser1 ~ testuser20），每個虛擬使用者使用專屬帳號
2. **優化每日登入積分邏輯**：改為直接呼叫資料庫函數，避免 HTTP 呼叫
3. **新增超時控制**：設定 API 超時時間（例如 5 秒）

---

#### **問題 5：查詢 API 全部失敗（100%）** 🔴 **嚴重**

**現象**：
- 98 次查詢請求全部返回 404 錯誤
- 查詢成功率：0%

**原因**：
- 測試帳號沒有債務記錄
- 或者 API 路徑錯誤
- 或者認證 token 無效（因為會話被踢掉）

**修復建議**：
1. 在測試前為測試帳號建立一些債務記錄
2. 檢查 API 路徑是否正確
3. 修復會話衝突問題

---

#### **問題 6：上傳 API 全部失敗（100%）** 🔴 **嚴重**

**現象**：
- 98 次上傳請求全部返回 500 錯誤
- 錯誤訊息：「系統錯誤，請稍後再試」
- 上傳成功率：0%

**可能原因**：
1. **CSV 格式錯誤**：測試腳本生成的 CSV 格式不正確
2. **認證 token 無效**：因為會話被踢掉，token 失效
3. **資料庫寫入失敗**：資料庫連線不足或其他錯誤
4. **檔案上傳邏輯問題**：API 本身有 bug

**修復建議**：
1. 檢查測試腳本生成的 CSV 格式
2. 修復會話衝突問題
3. 查看伺服器日誌，找出 500 錯誤的具體原因

---

#### **問題 7：回應時間異常** ⚠️ **效能問題**

| API | 平均 | 最小 | 最大 | P90 | P95 |
|-----|------|------|------|-----|-----|
| **HTTP 請求** | 523 ms | 15 ms | **9.51 秒** | 913 ms | 2.06 秒 |
| **註冊 API** | 29 ms | 15 ms | 345 ms | 31 ms | 40 ms |
| **登入 API** | 582 ms | 308 ms | **9.51 秒** | 2.01 秒 | 2.09 秒 |
| **查詢 API** | 49 ms | 26 ms | 1.23 秒 | 46 ms | 74 ms |
| **上傳 API** | 740 ms | 659 ms | 1.69 秒 | 785 ms | 861 ms |

**問題**：
- 登入 API 最大回應時間達到 **9.51 秒**（異常）
- 成功的登入請求平均回應時間：**2.26 秒**（非常慢）
- 上傳 API 平均回應時間：**740 ms**（偏高）

**可能原因**：
- 每日登入積分 API 呼叫超時
- 資料庫查詢慢
- 單裝置控制邏輯複雜
- 會話衝突導致重試

---

## 💡 修復建議總結

### **立即修復（高優先級）**

#### **1. 修復註冊帳號格式問題**
```javascript
// load-test.js
function testNewUserFlow(vuId, iteration) {
  const timestamp = Date.now().toString().slice(-6)
  const account = `test${vuId}${iteration}${timestamp}` // 移除底線
  // ...
}
```

#### **2. 增加測試帳號數量**
```typescript
// scripts/create-test-users-for-load-test.ts
// 建立 20 個測試帳號（testuser1 ~ testuser20）
const testUsers = Array.from({ length: 20 }, (_, i) => ({
  account: `testuser${i + 1}`,
  password: 'Test1234',
  // ...
}))
```

#### **3. 修改測試腳本使用專屬帳號**
```javascript
// load-test.js
function testExistingUserFlow(vuId, iteration) {
  // 每個 VU 使用專屬帳號
  const account = `testuser${vuId}`
  const password = 'Test1234'
  // ...
}
```

---

### **建議優化（中優先級）**

#### **4. 優化登入 API 效能**
- 將每日登入積分改為直接呼叫資料庫函數
- 新增超時控制（5 秒）
- 優化資料庫查詢

#### **5. 為測試帳號建立債務記錄**
- 在測試前為每個測試帳號建立 5-10 筆債務記錄
- 確保查詢 API 能正常運作

#### **6. 檢查上傳 API 錯誤**
- 查看伺服器日誌
- 檢查 CSV 格式
- 修復 500 錯誤

---

## 🎯 下一步行動計畫

### **階段 1：修復測試腳本（30 分鐘）**
1. ✅ 修復註冊帳號格式問題
2. ✅ 建立 20 個測試帳號
3. ✅ 修改測試腳本使用專屬帳號

### **階段 2：重新測試（10 分鐘）**
1. ✅ 執行壓力測試
2. ✅ 收集測試數據
3. ✅ 分析結果

### **階段 3：優化 API（視情況而定）**
1. ⏳ 優化登入 API 效能
2. ⏳ 修復上傳 API 錯誤
3. ⏳ 為測試帳號建立債務記錄

---

## 📝 結論

### **測試結果**
- ⚠️ **部分成功**：成功率從 0% 提升到 9.43%
- ❌ **仍有嚴重問題**：90.57% 的請求失敗

### **主要問題**
1. **註冊帳號格式錯誤**（100% 失敗）
2. **登入 API 高失敗率**（87.75% 失敗，主要原因是單裝置控制衝突）
3. **查詢和上傳 API 全部失敗**（100% 失敗）

### **根本原因**
- **測試腳本設計問題**：帳號格式錯誤、多個 VU 共用帳號
- **系統設計問題**：單裝置控制在高並發下會導致會話衝突
- **效能問題**：登入 API 回應時間過長（平均 2.26 秒）

### **建議**
1. **立即修復測試腳本**：修正帳號格式、增加測試帳號數量
2. **重新測試**：修復後再次執行壓力測試
3. **優化系統**：優化登入 API 效能、修復上傳 API 錯誤

---

**報告結束**

建議立即修復測試腳本問題，然後重新執行壓力測試以獲得更準確的效能數據。

