# ç¶ ç•Œé‡‘æµæ¸¬è©¦æŒ‡å—

## ğŸ¯ æ¸¬è©¦ç›®æ¨™
é©—è­‰ç¶ ç•Œé‡‘æµæ•´åˆæ˜¯å¦æ­£å¸¸é‹ä½œï¼ŒåŒ…æ‹¬ä»˜æ¬¾è¨‚å–®å»ºç«‹ã€ä»˜æ¬¾æµç¨‹ã€å›èª¿è™•ç†å’Œè¨‚é–±ç‹€æ…‹æ›´æ–°ã€‚

---

## ğŸ“‹ æ¸¬è©¦å‰æº–å‚™

### 1. ç¢ºèªç’°å¢ƒè¨­å®š

#### æª¢æŸ¥ `.env.local` æª”æ¡ˆ
```bash
# ç¢ºèªä»¥ä¸‹ç’°å¢ƒè®Šæ•¸å·²è¨­å®š
NEXT_PUBLIC_SUPABASE_URL=https://gwbmahlclpysbqeqkhez.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

### 2. è¨­å®šç¶ ç•Œæ¸¬è©¦ç’°å¢ƒ

#### æ–¹æ³• 1ï¼šé€éç®¡ç†å¾Œå°è¨­å®šï¼ˆæ¨è–¦ï¼‰

1. å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ï¼š
   ```bash
   npm run dev
   ```

2. ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿï¼š
   - å¸³è™Ÿï¼š`admin`ï¼ˆæˆ–ä½ çš„ç®¡ç†å“¡å¸³è™Ÿï¼‰
   - å¯†ç¢¼ï¼šä½ çš„å¯†ç¢¼

3. å‰å¾€ã€Œè¨‚é–±ç®¡ç†ã€â†’ã€Œç³»çµ±é…ç½®ã€

4. å¡«å…¥ç¶ ç•Œæ¸¬è©¦ç’°å¢ƒè¨­å®šï¼š
   - **å•†åº—ä»£è™Ÿï¼ˆMerchant IDï¼‰**: `2000132`
   - **Hash Key**: `5294y06JbISpM5x9`
   - **Hash IV**: `v77hoKGq4kWxNNIS`
   - **æ¸¬è©¦æ¨¡å¼**: âœ… å‹¾é¸

5. é»æ“Šã€Œå„²å­˜è¨­å®šã€

#### æ–¹æ³• 2ï¼šç›´æ¥åœ¨è³‡æ–™åº«è¨­å®š

åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š
```sql
UPDATE subscription_config
SET 
  ecpay_merchant_id = '2000132',
  ecpay_hash_key = '5294y06JbISpM5x9',
  ecpay_hash_iv = 'v77hoKGq4kWxNNIS',
  ecpay_test_mode = true,
  updated_at = NOW()
WHERE id = 1;
```

### 3. é©—è­‰è¨­å®š

åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š
```sql
SELECT 
  ecpay_merchant_id,
  ecpay_test_mode,
  monthly_price
FROM subscription_config
WHERE id = 1;
```

é æœŸçµæœï¼š
```
ecpay_merchant_id: 2000132
ecpay_test_mode: true
monthly_price: 1500
```

---

## ğŸ§ª æ¸¬è©¦æµç¨‹

### æ¸¬è©¦ 1ï¼šç¶ ç•Œå·¥å…·å‡½æ•¸æ¸¬è©¦

#### åŸ·è¡Œæ¸¬è©¦è…³æœ¬
```bash
node scripts/test-ecpay-utils.js
```

#### é æœŸçµæœ
```
ğŸ§ª ç¶ ç•Œå·¥å…·å‡½æ•¸æ¸¬è©¦

æ¸¬è©¦ 1: ç”¢ç”Ÿè¨‚å–®ç·¨è™Ÿ âœ…
æ¸¬è©¦ 2: æ ¼å¼åŒ–äº¤æ˜“æ™‚é–“ âœ…
æ¸¬è©¦ 3: ç”¢ç”Ÿæª¢æŸ¥ç¢¼ âœ…
æ¸¬è©¦ 4: é©—è­‰æª¢æŸ¥ç¢¼ âœ…
æ¸¬è©¦ 5: æ¨¡æ“¬ç¶ ç•Œå›èª¿ âœ…

ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼
```

---

### æ¸¬è©¦ 2ï¼šå»ºç«‹ä»˜æ¬¾è¨‚å–® API æ¸¬è©¦

#### ä½¿ç”¨ curl æ¸¬è©¦
```bash
# 1. å…ˆç™»å…¥å–å¾— token
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "account": "a689594",
    "password": "Qq123456"
  }'

# 2. è¤‡è£½å›æ‡‰ä¸­çš„ access_token

# 3. å»ºç«‹ä»˜æ¬¾è¨‚å–®
curl -X POST http://localhost:3000/api/subscription/payment/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "plan_type": "vip_monthly"
  }'
```

#### é æœŸå›æ‡‰
```json
{
  "success": true,
  "data": {
    "payment_id": "uuid",
    "merchant_trade_no": "ZHX17625504709504634",
    "amount": 1500,
    "form_data": {
      "MerchantID": "2000132",
      "MerchantTradeNo": "ZHX17625504709504634",
      "MerchantTradeDate": "2025/11/08 05:21:10",
      "PaymentType": "aio",
      "TotalAmount": 1500,
      "TradeDesc": "è‡»å¥½å°‹ - VIP æœˆè²»",
      "ItemName": "VIP æœˆè²»æœƒå“¡",
      "ReturnURL": "http://localhost:3000/api/subscription/payment/callback",
      "ChoosePayment": "ALL",
      "EncryptType": "1",
      "CheckMacValue": "..."
    },
    "action_url": "https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5"
  }
}
```

---

### æ¸¬è©¦ 3ï¼šå®Œæ•´ä»˜æ¬¾æµç¨‹æ¸¬è©¦ï¼ˆæ‰‹å‹•ï¼‰

#### æ­¥é©Ÿ 1ï¼šç™»å…¥æœƒå“¡å¸³è™Ÿ
1. å‰å¾€ http://localhost:3000/login
2. è¼¸å…¥å¸³è™Ÿï¼š`a689594`
3. è¼¸å…¥å¯†ç¢¼ï¼š`Qq123456`
4. é»æ“Šã€Œç™»å…¥ã€

#### æ­¥é©Ÿ 2ï¼šå‰å¾€è¨‚é–±ç®¡ç†
1. é»æ“Šå°è¦½åˆ—çš„ã€ŒğŸ’° è¨‚é–±ç®¡ç†ã€
2. ç¢ºèªç•¶å‰è¨‚é–±ç‹€æ…‹ï¼ˆæ‡‰ç‚ºã€Œå…è²»é«”é©—ã€ï¼‰

#### æ­¥é©Ÿ 3ï¼šå‰å¾€çºŒè²»é é¢
1. é»æ“Šã€Œç«‹å³çºŒè²»ã€æŒ‰éˆ•
2. æŸ¥çœ‹ VIP æœˆè²»æ–¹æ¡ˆè³‡è¨Š

#### æ­¥é©Ÿ 4ï¼šç™¼èµ·ä»˜æ¬¾
1. é»æ“Šã€Œç«‹å³è¨‚é–±ã€æŒ‰éˆ•
2. ç­‰å¾…è·³è½‰åˆ°ç¶ ç•Œä»˜æ¬¾é é¢
3. ç¢ºèªè·³è½‰æˆåŠŸï¼ˆURL æ‡‰ç‚º `payment-stage.ecpay.com.tw`ï¼‰

#### æ­¥é©Ÿ 5ï¼šå®Œæˆæ¸¬è©¦ä»˜æ¬¾
åœ¨ç¶ ç•Œæ¸¬è©¦ç’°å¢ƒä»˜æ¬¾é é¢ï¼š
1. é¸æ“‡ã€Œä¿¡ç”¨å¡ã€ä»˜æ¬¾æ–¹å¼
2. è¼¸å…¥æ¸¬è©¦ä¿¡ç”¨å¡è³‡è¨Šï¼š
   - **å¡è™Ÿ**: `4311-9522-2222-2222`
   - **æœ‰æ•ˆæœŸé™**: ä»»æ„æœªä¾†æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š`12/25`ï¼‰
   - **CVV**: `222`
   - **æŒå¡äººå§“å**: ä»»æ„åç¨±
3. é»æ“Šã€Œç¢ºèªä»˜æ¬¾ã€

#### æ­¥é©Ÿ 6ï¼šé©—è­‰ä»˜æ¬¾çµæœ
1. ä»˜æ¬¾å®Œæˆå¾Œæ‡‰å°å‘ `/subscription/payment/result`
2. ç¢ºèªé¡¯ç¤ºã€Œä»˜æ¬¾è™•ç†ä¸­ã€è¨Šæ¯
3. ç¢ºèªé¡¯ç¤ºå€’æ•¸è¨ˆæ™‚ï¼ˆ5 ç§’ï¼‰
4. ç­‰å¾…è‡ªå‹•å°å‘ `/subscription` é é¢

#### æ­¥é©Ÿ 7ï¼šé©—è­‰è¨‚é–±ç‹€æ…‹
åœ¨è¨‚é–±ç®¡ç†é é¢ç¢ºèªï¼š
- âœ… è¨‚é–±ç‹€æ…‹é¡¯ç¤ºã€ŒV.I.Pã€
- âœ… è¨‚é–±é¡å‹é¡¯ç¤ºã€ŒVIP æœˆè²»æœƒå“¡ã€
- âœ… è¨‚é–±ç‹€æ…‹é¡¯ç¤ºã€Œé€²è¡Œä¸­ã€
- âœ… çµæŸæ—¥æœŸç‚º 30 å¤©å¾Œ
- âœ… æ¯æ—¥é¡åº¦é¡¯ç¤ºã€Œä¸Šå‚³ 20 æ¬¡ã€æŸ¥è©¢ 30 æ¬¡ã€

#### æ­¥é©Ÿ 8ï¼šé©—è­‰å°è¦½åˆ—é¡¯ç¤º
åœ¨å°è¦½åˆ—ç¢ºèªï¼š
- âœ… æœƒå“¡è³‡è¨Šé¡¯ç¤ºã€ŒV.I.Pã€æ¨™ç±¤ï¼ˆé‡‘è‰²èƒŒæ™¯ + ğŸ‘‘ åœ–ç¤ºï¼‰
- âœ… å‰©é¤˜å¤©æ•¸é¡¯ç¤ºæ­£ç¢ºï¼ˆç´„ 30 å¤©ï¼‰
- âœ… é¡åº¦é¡¯ç¤ºæ­£ç¢ºï¼ˆä¸Šå‚³ 20/20ã€æŸ¥è©¢ 30/30ï¼‰

---

### æ¸¬è©¦ 4ï¼šè³‡æ–™åº«é©—è­‰

#### æª¢æŸ¥ä»˜æ¬¾è¨˜éŒ„
åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š
```sql
SELECT 
  id,
  user_id,
  amount,
  status,
  ecpay_merchant_trade_no,
  ecpay_trade_no,
  ecpay_payment_type,
  ecpay_rtn_code,
  ecpay_rtn_msg,
  paid_at,
  created_at
FROM payments
ORDER BY created_at DESC
LIMIT 5;
```

é æœŸçµæœï¼š
- `status`: `completed`
- `ecpay_rtn_code`: `1`
- `ecpay_rtn_msg`: `äº¤æ˜“æˆåŠŸ`
- `paid_at`: æœ‰å€¼

#### æª¢æŸ¥è¨‚é–±è¨˜éŒ„
åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š
```sql
SELECT 
  ms.id,
  ms.user_id,
  ms.status,
  ms.is_trial,
  ms.start_date,
  ms.end_date,
  sp.name as plan_name,
  sp.price
FROM member_subscriptions ms
JOIN subscription_plans sp ON ms.plan_id = sp.id
WHERE ms.user_id = (
  SELECT id FROM auth.users WHERE email = 'a689594@example.com'
)
ORDER BY ms.created_at DESC
LIMIT 1;
```

é æœŸçµæœï¼š
- `status`: `active`
- `is_trial`: `false`
- `plan_name`: `VIP æœˆè²»æœƒå“¡`
- `price`: `1500`
- `end_date`: ç´„ 30 å¤©å¾Œ

#### æª¢æŸ¥æ¯æ—¥é¡åº¦
åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š
```sql
SELECT 
  user_id,
  quota_date,
  uploads_used,
  queries_used,
  daily_upload_limit,
  daily_query_limit
FROM daily_usage_quotas
WHERE user_id = (
  SELECT id FROM auth.users WHERE email = 'a689594@example.com'
)
ORDER BY quota_date DESC
LIMIT 1;
```

é æœŸçµæœï¼š
- `daily_upload_limit`: `20`
- `daily_query_limit`: `30`
- `uploads_used`: `0`ï¼ˆå¦‚æœé‚„æ²’ä¸Šå‚³ï¼‰
- `queries_used`: `0`ï¼ˆå¦‚æœé‚„æ²’æŸ¥è©¢ï¼‰

---

## ğŸ› å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šç„¡æ³•è·³è½‰åˆ°ç¶ ç•Œä»˜æ¬¾é é¢

**å¯èƒ½åŸå› **ï¼š
- ç¶ ç•Œè¨­å®šæœªæ­£ç¢ºè¨­å®š
- NEXT_PUBLIC_BASE_URL æœªè¨­å®š

**è§£æ±ºæ–¹æ³•**ï¼š
1. æª¢æŸ¥ subscription_config è¡¨çš„ç¶ ç•Œè¨­å®š
2. æª¢æŸ¥ .env.local çš„ NEXT_PUBLIC_BASE_URL
3. é‡æ–°å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨

### å•é¡Œ 2ï¼šä»˜æ¬¾å®Œæˆå¾Œè¨‚é–±ç‹€æ…‹æœªæ›´æ–°

**å¯èƒ½åŸå› **ï¼š
- ç¶ ç•Œå›èª¿å¤±æ•—
- æª¢æŸ¥ç¢¼é©—è­‰å¤±æ•—
- è³‡æ–™åº«æ›´æ–°å¤±æ•—

**è§£æ±ºæ–¹æ³•**ï¼š
1. æª¢æŸ¥ç€è¦½å™¨ Console çš„éŒ¯èª¤è¨Šæ¯
2. æª¢æŸ¥ payments è¡¨çš„ status æ¬„ä½
3. æª¢æŸ¥ ecpay_rtn_code å’Œ ecpay_rtn_msg

### å•é¡Œ 3ï¼šæª¢æŸ¥ç¢¼é©—è­‰å¤±æ•—

**å¯èƒ½åŸå› **ï¼š
- HashKey æˆ– HashIV è¨­å®šéŒ¯èª¤
- åƒæ•¸é †åºéŒ¯èª¤
- URL ç·¨ç¢¼éŒ¯èª¤

**è§£æ±ºæ–¹æ³•**ï¼š
1. ç¢ºèª HashKey å’Œ HashIV æ­£ç¢º
2. åŸ·è¡Œ `node scripts/test-ecpay-utils.js` é©—è­‰å·¥å…·å‡½æ•¸
3. æª¢æŸ¥ç¶ ç•Œå›èª¿çš„åƒæ•¸

### å•é¡Œ 4ï¼šä»˜æ¬¾è¨˜éŒ„å»ºç«‹å¤±æ•—

**å¯èƒ½åŸå› **ï¼š
- è³‡æ–™åº«é€£ç·šå¤±æ•—
- RLS æ¬Šé™å•é¡Œ
- æ¬„ä½é¡å‹éŒ¯èª¤

**è§£æ±ºæ–¹æ³•**ï¼š
1. æª¢æŸ¥ Supabase é€£ç·šç‹€æ…‹
2. æª¢æŸ¥ payments è¡¨çš„ RLS æ”¿ç­–
3. æª¢æŸ¥ API éŒ¯èª¤æ—¥èªŒ

---

## ğŸ“Š æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### è¨­å®šæª¢æŸ¥
- [ ] å·²è¨­å®š NEXT_PUBLIC_BASE_URL ç’°å¢ƒè®Šæ•¸
- [ ] å·²åœ¨ç®¡ç†å¾Œå°è¨­å®šç¶ ç•Œè³‡è¨Š
- [ ] å·²ç¢ºèªæ¸¬è©¦æ¨¡å¼å·²å•Ÿç”¨
- [ ] å·²åŸ·è¡Œç¶ ç•Œå·¥å…·å‡½æ•¸æ¸¬è©¦

### åŠŸèƒ½æ¸¬è©¦
- [ ] å¯ä»¥å»ºç«‹ä»˜æ¬¾è¨‚å–®
- [ ] å¯ä»¥è·³è½‰åˆ°ç¶ ç•Œä»˜æ¬¾é é¢
- [ ] å¯ä»¥å®Œæˆæ¸¬è©¦ä»˜æ¬¾
- [ ] ç¶ ç•Œå›èª¿æˆåŠŸ
- [ ] ä»˜æ¬¾è¨˜éŒ„å·²å»ºç«‹
- [ ] è¨‚é–±ç‹€æ…‹å·²æ›´æ–°
- [ ] å°è¦½åˆ—é¡¯ç¤º VIP æ¨™ç±¤
- [ ] æ¯æ—¥é¡åº¦å·²æ›´æ–°

### è³‡æ–™åº«é©—è­‰
- [ ] payments è¡¨æœ‰æ–°è¨˜éŒ„
- [ ] status ç‚º completed
- [ ] ecpay_rtn_code ç‚º 1
- [ ] member_subscriptions è¡¨å·²æ›´æ–°
- [ ] status ç‚º active
- [ ] is_trial ç‚º false
- [ ] daily_usage_quotas è¡¨å·²æ›´æ–°
- [ ] daily_upload_limit ç‚º 20
- [ ] daily_query_limit ç‚º 30

### éŒ¯èª¤è™•ç†æ¸¬è©¦
- [ ] æœªè¨­å®šç¶ ç•Œè³‡è¨Šæ™‚é¡¯ç¤ºéŒ¯èª¤
- [ ] ä»˜æ¬¾å¤±æ•—æ™‚æ­£ç¢ºè™•ç†
- [ ] æª¢æŸ¥ç¢¼é©—è­‰å¤±æ•—æ™‚æ‹’çµ•
- [ ] é‡è¤‡å›èª¿æ™‚æ­£ç¢ºè™•ç†

---

## ğŸ‰ æ¸¬è©¦å®Œæˆ

å¦‚æœæ‰€æœ‰æ¸¬è©¦é …ç›®éƒ½é€šéï¼Œæ­å–œä½ ï¼ç¶ ç•Œé‡‘æµæ•´åˆå·²ç¶“æˆåŠŸå®Œæˆï¼

**ä¸‹ä¸€æ­¥**ï¼š
1. æº–å‚™ç”³è«‹ç¶ ç•Œæ­£å¼å•†åº—ä»£è™Ÿ
2. è¨­å®šæ­£å¼ç’°å¢ƒçš„ç¶ ç•Œåƒæ•¸
3. éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
4. ç›£æ§ä»˜æ¬¾æµç¨‹å’ŒéŒ¯èª¤æ—¥èªŒ

**æ³¨æ„äº‹é …**ï¼š
- æ¸¬è©¦ç’°å¢ƒä¸æœƒå¯¦éš›æ‰£æ¬¾
- æ­£å¼ç’°å¢ƒéœ€è¦é€šéç¶ ç•Œå¯©æ ¸
- æ­£å¼ç’°å¢ƒæœƒå¯¦éš›æ‰£æ¬¾
- å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒå……åˆ†æ¸¬è©¦å¾Œå†ä¸Šç·š

---

## ğŸ“ æ”¯æ´

å¦‚æœé‡åˆ°å•é¡Œï¼Œè«‹ï¼š
1. æª¢æŸ¥æœ¬æ–‡ä»¶çš„ã€Œå¸¸è¦‹å•é¡Œæ’æŸ¥ã€ç« ç¯€
2. æŸ¥çœ‹ `OTE/PHASE4_COMPLETION_REPORT.md` çš„è©³ç´°èªªæ˜
3. æŸ¥çœ‹ç¶ ç•Œå®˜æ–¹æ–‡ä»¶ï¼šhttps://www.ecpay.com.tw/
4. è¯ç¹«ç¶ ç•Œå®¢æœ

ç¥æ¸¬è©¦é †åˆ©ï¼ğŸš€

