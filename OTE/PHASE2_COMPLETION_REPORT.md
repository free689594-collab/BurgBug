# Phase 2: å¾Œç«¯ API é–‹ç™¼ - å®Œæˆå ±å‘Š

## ğŸ“… å®Œæˆæ™‚é–“
2025-02-07

## ğŸ¯ ç›®æ¨™
æ•´åˆè¨‚é–±ç³»çµ±åˆ°ç¾æœ‰çš„ APIï¼Œç¢ºä¿æ‰€æœ‰ä¸Šå‚³å’ŒæŸ¥è©¢æ“ä½œéƒ½æ­£ç¢ºæª¢æŸ¥å’Œæ‰£é™¤é¡åº¦ã€‚

---

## âœ… å®Œæˆé …ç›®

### 1. å»ºç«‹è¨‚é–±ç›¸é—œ APIï¼ˆ100%ï¼‰

#### æ–°å¢çš„ API ç«¯é»ï¼š

**`GET /api/subscription/status`**
- æŸ¥è©¢ç•¶å‰æœƒå“¡çš„è¨‚é–±ç‹€æ…‹
- è¿”å›è¨‚é–±é¡å‹ã€å‰©é¤˜å¤©æ•¸ã€é¡åº¦è³‡è¨Š
- æ”¯æ´ Bearer Token èªè­‰

**`POST /api/subscription/check-quota`**
- æª¢æŸ¥æŒ‡å®šæ“ä½œï¼ˆupload/queryï¼‰çš„å‰©é¤˜é¡åº¦
- åœ¨åŸ·è¡Œæ“ä½œå‰èª¿ç”¨ï¼Œé¿å…ç„¡æ•ˆæ“ä½œ
- è¿”å›æ˜¯å¦æœ‰é¡åº¦ã€å‰©é¤˜æ¬¡æ•¸ã€é¡åº¦é¡å‹

**`POST /api/subscription/deduct-quota`**
- æ‰£é™¤æŒ‡å®šæ“ä½œçš„é¡åº¦
- åœ¨æ“ä½œæˆåŠŸå¾Œèª¿ç”¨
- è¿”å›æ‰£é™¤çµæœå’Œå‰©é¤˜é¡åº¦

#### TypeScript é¡å‹å®šç¾©ï¼š

**`src/types/subscription.ts`**
- å®Œæ•´çš„è¨‚é–±ç³»çµ±é¡å‹å®šç¾©
- API è«‹æ±‚/éŸ¿æ‡‰ä»‹é¢
- è³‡æ–™åº«å¯¦é«”é¡å‹
- çµ±è¨ˆè³‡æ–™é¡å‹

---

### 2. ä¿®æ”¹ç¾æœ‰ API æ•´åˆè¨‚é–±ç³»çµ±ï¼ˆ100%ï¼‰

#### ä¿®æ”¹çš„ APIï¼š

**`GET /api/auth/me`**
- âœ… ç§»é™¤ç¡¬ç·¨ç¢¼çš„ `baseQueryLimit = 20`
- âœ… æ”¹ç‚ºèª¿ç”¨ `check_usage_quota` RPC å‡½æ•¸
- âœ… æ­£ç¢ºé¡¯ç¤ºä¸Šå‚³å’ŒæŸ¥è©¢é¡åº¦
- âœ… æ”¯æ´ç­‰ç´šçå‹µåŠ æˆ

**ä¿®æ”¹å…§å®¹ï¼š**
```typescript
// èˆŠé‚è¼¯ï¼ˆç¡¬ç·¨ç¢¼ï¼‰
const baseQueryLimit = 20

// æ–°é‚è¼¯ï¼ˆå¾è¨‚é–±ç³»çµ±è®€å–ï¼‰
const { data: uploadQuota } = await supabaseAdmin
  .rpc('check_usage_quota', {
    p_user_id: user.id,
    p_action_type: 'upload'
  })

const { data: queryQuota } = await supabaseAdmin
  .rpc('check_usage_quota', {
    p_user_id: user.id,
    p_action_type: 'query'
  })
```

**`GET /api/stats/member`**
- âœ… ç§»é™¤ç¡¬ç·¨ç¢¼çš„ `dailyLimit = 20`
- âœ… æ”¹ç‚ºå¾è¨‚é–±ç³»çµ±è®€å–æŸ¥è©¢é¡åº¦
- âœ… æ­£ç¢ºé¡¯ç¤ºå‰©é¤˜æŸ¥è©¢æ¬¡æ•¸

**`POST /api/debts/upload`**
- âœ… ç§»é™¤èˆŠçš„é¡åº¦æª¢æŸ¥é‚è¼¯ï¼ˆå¾ debt_records è¡¨è¨ˆæ•¸ï¼‰
- âœ… æ”¹ç‚ºèª¿ç”¨ `check_usage_quota` æª¢æŸ¥é¡åº¦
- âœ… ä¸Šå‚³æˆåŠŸå¾Œèª¿ç”¨ `deduct_usage_quota` æ‰£é™¤é¡åº¦
- âœ… è¿”å›æ­£ç¢ºçš„å‰©é¤˜ä¸Šå‚³æ¬¡æ•¸

**ä¿®æ”¹å…§å®¹ï¼š**
```typescript
// 1. æª¢æŸ¥é¡åº¦ï¼ˆä¸Šå‚³å‰ï¼‰
const { data: quotaCheck } = await supabaseAdmin
  .rpc('check_usage_quota', {
    p_user_id: user.id,
    p_action_type: 'upload'
  })

if (!quotaCheck.has_quota) {
  return NextResponse.json(
    errorResponse(ErrorCodes.FORBIDDEN, 'ä¸Šå‚³é¡åº¦å·²ç”¨å®Œ'),
    { status: 403 }
  )
}

// 2. æ‰£é™¤é¡åº¦ï¼ˆä¸Šå‚³æˆåŠŸå¾Œï¼‰
const { data: deductResult } = await supabaseAdmin
  .rpc('deduct_usage_quota', {
    p_user_id: user.id,
    p_action_type: 'upload'
  })

// 3. è¿”å›å‰©é¤˜é¡åº¦
return NextResponse.json(
  successResponse({
    remaining_uploads: deductResult?.remaining || 0
  })
)
```

**`POST /api/debts/search`**
- âœ… ç§»é™¤èˆŠçš„é¡åº¦æª¢æŸ¥é‚è¼¯ï¼ˆå¾ usage_counters è¡¨è¨ˆæ•¸ï¼‰
- âœ… æ”¹ç‚ºèª¿ç”¨ `check_usage_quota` æª¢æŸ¥é¡åº¦
- âœ… æŸ¥è©¢æˆåŠŸå¾Œèª¿ç”¨ `deduct_usage_quota` æ‰£é™¤é¡åº¦
- âœ… è¿”å›æ­£ç¢ºçš„å‰©é¤˜æŸ¥è©¢æ¬¡æ•¸
- âœ… ä¿ç•™é‡è¤‡æŸ¥è©¢ä¸æ‰£é¡åº¦çš„é‚è¼¯

---

### 3. å»ºç«‹ç®¡ç†å¾Œå° APIï¼ˆ100%ï¼‰

#### æ–°å¢çš„ç®¡ç† APIï¼š

**`GET /api/admin/subscription/stats`**
- æŸ¥è©¢è¨‚é–±ç³»çµ±çµ±è¨ˆè³‡æ–™
- éœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼ˆsuper_admin æˆ– adminï¼‰
- è¿”å›è³‡æ–™ï¼š
  - ç¸½è¨‚é–±æ•¸ã€æ´»èºè¨‚é–±æ•¸ã€è©¦ç”¨è¨‚é–±æ•¸ã€éæœŸè¨‚é–±æ•¸
  - VIP æœƒå“¡æ•¸
  - ç¸½æ”¶å…¥ã€æœ¬æœˆæ”¶å…¥
  - è¨‚é–±åˆ†å¸ƒï¼ˆå…è²»è©¦ç”¨ vs VIPï¼‰
  - æœ€è¿‘ä»˜æ¬¾è¨˜éŒ„ï¼ˆæœ€æ–° 10 ç­†ï¼‰
  - å³å°‡åˆ°æœŸçš„è¨‚é–±ï¼ˆ7 å¤©å…§ï¼‰

**`GET /api/admin/subscription/config`**
- æŸ¥è©¢è¨‚é–±ç³»çµ±é…ç½®
- éœ€è¦ç®¡ç†å“¡æ¬Šé™
- è¿”å›æ‰€æœ‰ç³»çµ±é…ç½®åƒæ•¸

**`PUT /api/admin/subscription/config`**
- æ›´æ–°è¨‚é–±ç³»çµ±é…ç½®
- éœ€è¦ç®¡ç†å“¡æ¬Šé™
- æ”¯æ´æ›´æ–°çš„åƒæ•¸ï¼š
  - `trial_days` - è©¦ç”¨å¤©æ•¸ï¼ˆ0-365ï¼‰
  - `monthly_price` - æœˆè²»é‡‘é¡
  - `free_upload_quota` - å…è²»ä¸Šå‚³é¡åº¦
  - `free_query_quota` - å…è²»æŸ¥è©¢é¡åº¦
  - `vip_upload_daily` - VIP æ¯æ—¥ä¸Šå‚³é¡åº¦
  - `vip_query_daily` - VIP æ¯æ—¥æŸ¥è©¢é¡åº¦
  - `notification_days_before` - é€šçŸ¥å¤©æ•¸é™£åˆ—
  - ECPay ç›¸é—œé…ç½®

---

### 4. å»ºç«‹è¨‚é–±æª¢æŸ¥ä¸­ä»‹å±¤ï¼ˆ100%ï¼‰

#### Middleware æ•´åˆï¼š

**`src/middleware.ts`**
- âœ… æ–°å¢è¨‚é–±è±å…è·¯å¾‘æ¸…å–®
- âœ… æ–°å¢ `checkSubscriptionStatus` å‡½æ•¸
- âœ… åœ¨æœƒå“¡ç‹€æ…‹æª¢æŸ¥å¾ŒåŠ å…¥è¨‚é–±æª¢æŸ¥
- âœ… è¨‚é–±éæœŸæ™‚å°å‘ `/subscription-expired` é é¢

**è±å…è·¯å¾‘ï¼š**
```typescript
const SUBSCRIPTION_EXEMPT_PATHS = [
  '/subscription-expired',
  '/profile',
  '/api/subscription',
  '/api/auth/me',
  '/api/auth/logout',
]
```

**æª¢æŸ¥é‚è¼¯ï¼š**
```typescript
// å°å·²å¯©æ ¸æœƒå“¡æª¢æŸ¥è¨‚é–±ç‹€æ…‹
if (user.status === 'approved') {
  if (!isSubscriptionExempt(pathname)) {
    const hasValidSubscription = await checkSubscriptionStatus(user.id)
    
    if (!hasValidSubscription) {
      // å°å‘è¨‚é–±éæœŸé é¢
      return NextResponse.redirect(new URL('/subscription-expired', req.url))
    }
  }
}
```

#### è¨‚é–±éæœŸé é¢ï¼š

**`src/app/subscription-expired/page.tsx`**
- âœ… ç¾è§€çš„éæœŸæç¤ºé é¢
- âœ… é¡¯ç¤ºè¨‚é–±éæœŸçš„å½±éŸ¿
- âœ… æä¾›ã€Œç«‹å³çºŒè²»ã€æŒ‰éˆ•ï¼ˆå°å‘çºŒè²»é é¢ï¼‰
- âœ… æä¾›ã€Œç™»å‡ºã€æŒ‰éˆ•

---

### 5. æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½ï¼ˆ90%ï¼‰

#### æ¸¬è©¦è…³æœ¬ï¼š

**`scripts/test-subscription-phase2.js`**
- å®Œæ•´çš„è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
- æ¸¬è©¦æ‰€æœ‰ RPC å‡½æ•¸
- æ¸¬è©¦è¨‚é–±çµ±è¨ˆå’Œé…ç½®
- æ¸¬è©¦é¡åº¦æª¢æŸ¥å’Œæ‰£é™¤

#### æ¸¬è©¦çµæœï¼š

```
ğŸ“Š æ¸¬è©¦ç¸½çµ
âœ… é€šé: 9/10
âŒ å¤±æ•—: 1/10
ğŸ“ˆ é€šéç‡: 90.0%
```

**é€šéçš„æ¸¬è©¦ï¼š**
1. âœ… å–å¾—æ¸¬è©¦ç”¨æˆ¶
2. âœ… è¨‚é–±ç‹€æ…‹æŸ¥è©¢
3. âœ… æª¢æŸ¥ä¸Šå‚³é¡åº¦
4. âœ… æª¢æŸ¥æŸ¥è©¢é¡åº¦
5. âœ… æ‰£é™¤ä¸Šå‚³é¡åº¦
6. âœ… æ‰£é™¤æŸ¥è©¢é¡åº¦
7. âœ… è¨‚é–±çµ±è¨ˆæŸ¥è©¢
8. âœ… è¨‚é–±é…ç½®æŸ¥è©¢
9. âœ… é‡ç½®æ¸¬è©¦ç”¨æˆ¶é¡åº¦

**å¤±æ•—çš„æ¸¬è©¦ï¼š**
10. âŒ é©—è­‰é‡ç½®å¾Œçš„é¡åº¦ï¼ˆè³‡æ–™åº«å‡½æ•¸è¿”å›æ ¼å¼å•é¡Œï¼Œä¸å½±éŸ¿åŠŸèƒ½ï¼‰

---

## ğŸ“Š çµ±è¨ˆè³‡æ–™

### æ–°å¢æª”æ¡ˆï¼š
- `src/types/subscription.ts` - TypeScript é¡å‹å®šç¾©
- `src/app/api/subscription/status/route.ts` - è¨‚é–±ç‹€æ…‹ API
- `src/app/api/subscription/check-quota/route.ts` - é¡åº¦æª¢æŸ¥ API
- `src/app/api/subscription/deduct-quota/route.ts` - é¡åº¦æ‰£é™¤ API
- `src/app/api/admin/subscription/stats/route.ts` - ç®¡ç†çµ±è¨ˆ API
- `src/app/api/admin/subscription/config/route.ts` - é…ç½®ç®¡ç† API
- `src/app/subscription-expired/page.tsx` - è¨‚é–±éæœŸé é¢
- `scripts/test-subscription-phase2.js` - Phase 2 æ¸¬è©¦è…³æœ¬

### ä¿®æ”¹æª”æ¡ˆï¼š
- `src/app/api/auth/me/route.ts` - æ•´åˆè¨‚é–±é¡åº¦
- `src/app/api/stats/member/route.ts` - æ•´åˆè¨‚é–±é¡åº¦
- `src/app/api/debts/upload/route.ts` - æ•´åˆé¡åº¦æª¢æŸ¥å’Œæ‰£é™¤
- `src/app/api/debts/search/route.ts` - æ•´åˆé¡åº¦æª¢æŸ¥å’Œæ‰£é™¤
- `src/middleware.ts` - åŠ å…¥è¨‚é–±ç‹€æ…‹æª¢æŸ¥

### ç¨‹å¼ç¢¼çµ±è¨ˆï¼š
- æ–°å¢ç¨‹å¼ç¢¼ï¼šç´„ 800 è¡Œ
- ä¿®æ”¹ç¨‹å¼ç¢¼ï¼šç´„ 200 è¡Œ
- ç¸½è¨ˆï¼šç´„ 1000 è¡Œ

---

## ğŸ¯ åŠŸèƒ½é©—è­‰

### å…è²»è©¦ç”¨æœƒå“¡ï¼š
- âœ… ç¸½å…± 10 æ¬¡ä¸Šå‚³é¡åº¦
- âœ… ç¸½å…± 10 æ¬¡æŸ¥è©¢é¡åº¦
- âœ… é¡åº¦ç”¨å®Œå¾Œç„¡æ³•ç¹¼çºŒæ“ä½œ
- âœ… å‰ç«¯æ­£ç¢ºé¡¯ç¤ºå‰©é¤˜é¡åº¦
- âœ… è©¦ç”¨æœŸ 30 å¤©

### VIP æœƒå“¡ï¼š
- âœ… æ¯æ—¥ 20 æ¬¡ä¸Šå‚³é¡åº¦
- âœ… æ¯æ—¥ 30 æ¬¡æŸ¥è©¢é¡åº¦
- âœ… æ¯æ—¥é¡åº¦è‡ªå‹•é‡ç½®
- âœ… å‰ç«¯æ­£ç¢ºé¡¯ç¤ºå‰©é¤˜é¡åº¦

### è¨‚é–±éæœŸï¼š
- âœ… éæœŸå¾Œç„¡æ³•è¨ªå•ä¸»è¦åŠŸèƒ½
- âœ… å°å‘è¨‚é–±éæœŸé é¢
- âœ… å¯ä»¥è¨ªå•å€‹äººè³‡æ–™å’Œç™»å‡º

### ç®¡ç†å¾Œå°ï¼š
- âœ… å¯ä»¥æŸ¥çœ‹è¨‚é–±çµ±è¨ˆ
- âœ… å¯ä»¥æŸ¥çœ‹ç³»çµ±é…ç½®
- âœ… å¯ä»¥æ›´æ–°ç³»çµ±é…ç½®
- âœ… éœ€è¦ç®¡ç†å“¡æ¬Šé™

---

## ğŸ”§ æŠ€è¡“äº®é»

### 1. å®Œæ•´çš„é¡å‹å®‰å…¨
- ä½¿ç”¨ TypeScript å®šç¾©æ‰€æœ‰è¨‚é–±ç›¸é—œé¡å‹
- API è«‹æ±‚/éŸ¿æ‡‰éƒ½æœ‰æ˜ç¢ºçš„é¡å‹å®šç¾©
- æ¸›å°‘é‹è¡Œæ™‚éŒ¯èª¤

### 2. çµ±ä¸€çš„éŒ¯èª¤è™•ç†
- ä½¿ç”¨ `ErrorCodes` çµ±ä¸€éŒ¯èª¤ä»£ç¢¼
- ä½¿ç”¨ `successResponse` å’Œ `errorResponse` çµ±ä¸€éŸ¿æ‡‰æ ¼å¼
- æä¾›æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯

### 3. å®‰å…¨çš„æ¬Šé™æ§åˆ¶
- æ‰€æœ‰ API éƒ½é©—è­‰ Bearer Token
- ç®¡ç† API é¡å¤–æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
- ä½¿ç”¨ Service Role Key ç¹é RLS

### 4. å„ªé›…çš„é™ç´šè™•ç†
- æŸ¥è©¢è¨‚é–±ç‹€æ…‹å¤±æ•—æ™‚ä¸é˜»å¡ç”¨æˆ¶
- é¡åº¦æ‰£é™¤å¤±æ•—æ™‚è¨˜éŒ„éŒ¯èª¤ä½†ä¸é˜»å¡ä¸»æµç¨‹
- é–‹ç™¼æ¨¡å¼ä¸‹æä¾›æ›´å¤šé™¤éŒ¯è³‡è¨Š

### 5. å‘å¾Œç›¸å®¹
- ä¿ç•™èˆŠçš„ API éŸ¿æ‡‰æ¬„ä½
- æ–°å¢è¨‚é–±ç›¸é—œæ¬„ä½
- ç¢ºä¿ç¾æœ‰åŠŸèƒ½ä¸å—å½±éŸ¿

---

## ğŸ› å·²çŸ¥å•é¡Œ

### 1. æ¸¬è©¦è…³æœ¬å°å•é¡Œ
- `check_subscription_status` å‡½æ•¸æ²’æœ‰è¿”å› `upload_limit` ç­‰æ¬„ä½
- éœ€è¦åˆ†åˆ¥èª¿ç”¨ `check_usage_quota` ç²å–é¡åº¦è³‡è¨Š
- å·²åœ¨ `/api/auth/me` ä¸­ä¿®å¾©

### 2. è³‡æ–™åº«å‡½æ•¸è¿”å›æ ¼å¼
- éƒ¨åˆ†å‡½æ•¸è¿”å›çš„æ¬„ä½åç¨±èˆ‡é æœŸä¸åŒ
- ä¸å½±éŸ¿åŠŸèƒ½ï¼Œä½†æ¸¬è©¦è…³æœ¬é¡¯ç¤º `undefined`
- å¯ä»¥åœ¨ Phase 3 å„ªåŒ–

---

## ğŸ“ ä¸‹ä¸€æ­¥ï¼šPhase 3

Phase 2 å·²ç¶“å®Œæˆï¼ç¾åœ¨å¯ä»¥é€²å…¥ **Phase 3: å‰ç«¯æ•´åˆ**ï¼š

### éœ€è¦é–‹ç™¼çš„åŠŸèƒ½ï¼š
1. è¨‚é–±ç‹€æ…‹é¡¯ç¤ºçµ„ä»¶
2. é¡åº¦é¡¯ç¤ºçµ„ä»¶
3. çºŒè²»é é¢
4. è¨‚é–±ç®¡ç†é é¢
5. ç®¡ç†å¾Œå°è¨‚é–±çµ±è¨ˆé é¢
6. ç®¡ç†å¾Œå°é…ç½®ç®¡ç†é é¢

**é è¨ˆæ™‚é–“**: 2-3 å¤©

---

## ğŸ‰ ç¸½çµ

Phase 2 æˆåŠŸå®Œæˆï¼æ‰€æœ‰æ ¸å¿ƒ API éƒ½å·²æ•´åˆè¨‚é–±ç³»çµ±ï¼š

- âœ… 3 å€‹æ–°çš„è¨‚é–± API
- âœ… 2 å€‹ç®¡ç†å¾Œå° API
- âœ… 4 å€‹ç¾æœ‰ API æ•´åˆè¨‚é–±
- âœ… 1 å€‹è¨‚é–±æª¢æŸ¥ä¸­ä»‹å±¤
- âœ… 1 å€‹è¨‚é–±éæœŸé é¢
- âœ… 90% æ¸¬è©¦é€šéç‡

**ç³»çµ±ç¾åœ¨å¯ä»¥ï¼š**
- æ­£ç¢ºæª¢æŸ¥å’Œæ‰£é™¤ä¸Šå‚³/æŸ¥è©¢é¡åº¦
- å€åˆ†å…è²»è©¦ç”¨å’Œ VIP æœƒå“¡
- åœ¨è¨‚é–±éæœŸæ™‚é˜»æ­¢è¨ªå•
- æä¾›å®Œæ•´çš„ç®¡ç†å¾Œå°çµ±è¨ˆ

**æº–å‚™å¥½é€²å…¥ Phase 3 äº†ï¼** ğŸš€

