# 債務查詢系統需求文檔

## 專案概述

債務查詢系統是一個專為金融業務從業人員設計的債務人資訊共享平台。系統核心功能是讓已審核的會員能夠上傳債務人資料，並查詢特定債務人的多筆借款記錄，以評估債務人的整體負債狀況。

## 需求規格

## 更新補充（已確認，2025-10）

### 帳號登入與命名規範
- 帳號（account）為必填，長度 5–15，僅允許英數字 A–Z/a–z/0–9；大小寫不敏感（唯一性以小寫比對）
- 信箱為選填；登入改為「帳號 + 密碼」，後端以 `${account}@auth.local` 映射成 email 與 Supabase Auth 互動（已關閉信箱驗證）
- 註冊時若帳號已存在，系統 SHALL 回覆明確訊息「此帳號已存在，請更換其他帳號」
- 註冊防濫用：系統 SHALL 對註冊介面實施節流/速率限制與人機驗證（e.g., hCaptcha）

### 查詢條件變更（強化二次確認）
- 會員查詢債務資料時，系統 SHALL 要求輸入「身分證首字母（A–Z）」與「身分證後 5 碼」兩者皆提供方可回傳結果
- 參數驗證：首字母僅允許 1 個英文字母（不分大小寫），後 5 碼需符合身分證規則的字元集/長度

### 債務資料欄位調整
- debt_records 新增：
  - `debt_date DATE`（債務日期，年/月/日合併為單欄）
  - `face_value DECIMAL(15,2)`（票面金額，原 amount 之名稱調整）
  - `payment_frequency TEXT`，允許值：`daily`｜`weekly`｜`monthly`（以 CHECK 約束實作）
- 查詢結果與前端顯示 SHALL 新增 `payment_frequency` 欄位（非敏感，不受遮罩）

### 展示數據（灌水）配置
- 管理員可針對 6 小區（北北基宜、桃竹苗、中彰投、雲嘉南、高屏澎、花東）調整「展示增量」（+1～+50）
- 配置存放於 `system_config` 的 JSON（key: `display_overrides`），格式例如：
  `{ "北北基宜": 3, "桃竹苗": 1, "中彰投": 0, "雲嘉南": 2, "高屏澎": 0, "花東": 4 }`
- 會員端顯示「實際數據 + 展示增量」；管理員端同時顯示「實際數據」與「展示數據」並可即時調整（無版本/立即生效）

### 審計日誌保留策略
- 查詢行為與管理員敏感操作之審計日誌保留 30 天；值可由 `system_config.audit_retention_days` 調整
- 系統 SHALL 以排程每日清理超過保留天數的日誌紀錄

### 會員儀表板：票面總額統計
- 系統 SHALL 在「我的債務人管理」頁回傳並顯示會員上傳資料之 `face_value` 加總（排除軟刪除）


### 需求 1：用戶註冊與審核系統

**用戶故事：** 作為金融業務從業人員，我希望能夠註冊帳號並通過管理員審核，以便使用債務查詢功能。

#### 驗收標準
1. WHEN 用戶填寫註冊表單 THEN 系統 SHALL 驗證所有必填欄位（帳號、密碼、暱稱、業務類型、業務區域）並創建待審核帳號
2. WHEN 用戶輸入帳號 THEN 系統 SHALL 驗證帳號格式（5-15字元、僅限英文字母與數字、大小寫不敏感唯一性）
3. WHEN 用戶輸入已存在的帳號 THEN 系統 SHALL 明確提示「此帳號已存在，請更換其他帳號」
4. WHEN 用戶註冊成功 THEN 系統 SHALL 重定向到等待審核頁面
5. WHEN 管理員審核用戶 THEN 系統 SHALL 更新用戶狀態為已審核或暫停
6. WHEN 用戶狀態變更 THEN 系統 SHALL 記錄完整的審計日誌

#### 技術規格
- 註冊方式：使用「帳號 + 密碼」，不使用信箱登入
- 帳號規範：長度 5-15 字元、僅限 A-Z/a-z/0-9、大小寫不敏感（UserA 與 usera 視為同一帳號）
- 信箱欄位：選填（僅用於通知，不用於登入）
- 認證實作：使用 Supabase Auth，帳號映射為 `${account}@auth.local` 格式的內部信箱

### 需求 2：債務人資料管理

**用戶故事：** 作為已審核會員，我希望能夠上傳債務人資料，以便與其他會員共享債務人資訊。

#### 驗收標準
1. WHEN 已審核會員填寫債務人表單 THEN 系統 SHALL 驗證所有必填欄位並儲存資料
2. WHEN 債務人資料儲存 THEN 系統 SHALL 自動提取身分證後5碼與首字母用於查詢索引
3. WHEN 會員查看任何債務人資料（包含自己上傳） THEN 系統 SHALL 對姓名、手機、身分證進行遮罩顯示
4. WHEN 管理員查看債務人資料 THEN 系統 SHALL 顯示完整未遮罩資訊

#### 債務人資料欄位規格
**第一區：債務人基本資料**
- 姓名（必填）
- 性別（必填）
- 身分證（必填，自動提取首字母與後5碼）
- 手機（選填）
- 職業（選填）
- 居住地（必填，六大區域）

**第二區：債務資料**
- 債務日期（必填，年/月/日）
- 票面金額（必填，DECIMAL 格式）
- 還款配合（必填，選項：日結/周結/月結）
- 目前還款狀況（必填，選項：待觀察/正常/結清/議價結清/代償/疲勞/呆帳）
- 備註（選填）

### 需求 3：債務查詢功能

**用戶故事：** 作為已審核會員，我希望能夠查詢債務人的所有借款記錄，以便評估其整體負債狀況。

#### 驗收標準
1. WHEN 會員輸入身分證首字母與後5碼 THEN 系統 SHALL 返回所有匹配的債務記錄
2. WHEN 會員僅輸入後5碼未輸入首字母 THEN 系統 SHALL 拒絕查詢並提示「請輸入身分證首字母」
3. WHEN 查詢結果包含多筆記錄 THEN 系統 SHALL 顯示不同會員上傳的同一債務人資料
4. WHEN 顯示查詢結果 THEN 系統 SHALL 對敏感資訊進行遮罩處理並顯示「還款配合」欄位
5. WHEN 執行查詢操作 THEN 系統 SHALL 記錄查詢日誌（查詢者、查詢條件、結果數量、時間戳）

#### 查詢邏輯規格
- 查詢條件：身分證首字母（A-Z，單一字母）+ 身分證後5碼（數字/字母組合）
- 比對方式：首字母不區分大小寫，後5碼精確匹配
- 索引優化：使用複合索引 (debtor_id_first_letter, debtor_id_last5)
- 查詢日誌保留：30 天（可於 system_config 配置）

### 需求 4：管理員後台系統

**用戶故事：** 作為系統管理員，我希望能夠管理會員審核、查看系統統計和處理用戶請求。

#### 驗收標準
1. WHEN 管理員登入後台 THEN 系統 SHALL 顯示待審核會員列表和系統統計
2. WHEN 管理員審核會員 THEN 系統 SHALL 允許通過或暫停用戶並添加備註
3. WHEN 管理員處理密碼重置請求 THEN 系統 SHALL 提供安全的密碼重置功能
4. WHEN 管理員查看審計日誌 THEN 系統 SHALL 顯示所有用戶操作記錄

### 需求 5：系統安全與權限控制

**用戶故事：** 作為系統使用者，我希望系統能夠保護敏感資料並確保只有授權用戶能夠訪問相應功能。

#### 驗收標準
1. WHEN 未審核用戶嘗試訪問功能頁面 THEN 系統 SHALL 重定向到等待審核頁面
2. WHEN 暫停用戶嘗試登入 THEN 系統 SHALL 顯示帳號暫停通知
3. WHEN 任何用戶查看債務資料 THEN 系統 SHALL 根據權限等級顯示適當的遮罩資訊
4. WHEN 系統檢測到異常操作 THEN 系統 SHALL 記錄安全日誌並採取防護措施

### 需求 6：使用頻率與多設備控制

**用戶故事：** 作為平台營運者，我希望能夠控制會員的使用頻率和設備數量，以確保平台資源合理使用和防止帳號濫用。

#### 驗收標準
1. WHEN 會員每日上傳超過20筆資料 THEN 系統 SHALL 阻止上傳並顯示限制提示
2. WHEN 會員每日查詢超過30次 THEN 系統 SHALL 阻止查詢並顯示限制提示
3. WHEN 會員在新設備/IP登入 THEN 系統 SHALL 檢查是否已有其他活躍會話
4. WHEN 檢測到多設備同時使用 THEN 系統 SHALL 發送警告並記錄違規行為
5. WHEN 會員屢次違規多設備使用 THEN 系統 SHALL 自動暫停帳號

### 需求 7：商業化功能與擴展性

**用戶故事：** 作為平台營運者，我希望系統具備良好的擴展性和商業化功能，以支持未來的發展需求。

#### 驗收標準
1. WHEN 系統用戶數增長 THEN 系統 SHALL 保持穩定的性能表現
2. WHEN 需要新增功能模組 THEN 系統 SHALL 支持模組化擴展
3. WHEN 部署智能體輔助管理 THEN 系統 SHALL 提供標準化的 API 介面
4. WHEN 監控系統資源使用 THEN 系統 SHALL 提供詳細的使用統計和告警機制

### 需求 8：會員資料修改申請系統

**用戶故事：** 作為已審核會員，我希望能夠申請修改個人資料，並通過管理員審核後生效。

#### 驗收標準
1. WHEN 會員申請修改個人資料 THEN 系統 SHALL 創建修改申請並發送給管理員審核
2. WHEN 管理員審核修改申請 THEN 系統 SHALL 允許通過或拒絕並添加審核備註
3. WHEN 修改申請通過 THEN 系統 SHALL 自動更新會員資料並通知會員
4. WHEN 修改申請被拒絕 THEN 系統 SHALL 通知會員拒絕原因

### 需求 9：債務人資料編輯與確認機制

**用戶故事：** 作為已審核會員，我希望能夠修改債務人的還款狀態，並對其他資料錯誤提出修改申請。

#### 驗收標準
1. WHEN 會員上傳債務人資料 THEN 系統 SHALL 要求會員確認兩次才能提交
2. WHEN 會員修改債務人還款狀態 THEN 系統 SHALL 直接更新無需審核
3. WHEN 會員申請修改其他債務人資料 THEN 系統 SHALL 創建修改申請發送給管理員
4. WHEN 債務人資料修改申請處理 THEN 系統 SHALL 記錄修改歷史和審核結果

### 需求 10：會員信箱與通知系統

**用戶故事：** 作為系統用戶，我希望能夠接收系統通知和與管理員進行溝通。

#### 驗收標準
1. WHEN 用戶狀態變更 THEN 系統 SHALL 自動發送通知到會員信箱
2. WHEN 會員發送訊息給管理員 THEN 系統 SHALL 儲存到會員信箱並標記狀態
3. WHEN 管理員回覆訊息 THEN 系統 SHALL 通知會員並更新信箱狀態
4. WHEN 系統檢測到違規行為 THEN 系統 SHALL 自動發送警告通知

### 需求 11：違規處理與申訴機制

**用戶故事：** 作為平台營運者，我希望能夠自動處理違規行為並提供申訴管道。

#### 驗收標準
1. WHEN 檢測到多設備登入 THEN 系統 SHALL 發送口頭警告並記錄違規
2. WHEN 會員初次違規 THEN 系統 SHALL 暫停帳號3天並允許申訴
3. WHEN 會員累犯違規 THEN 系統 SHALL 暫停帳號10天並允許申訴
4. WHEN 暫停期間 THEN 系統 SHALL 只允許會員使用站內信聯繫管理員

### 需求 12：會員首頁統計與活躍度系統

**用戶故事：** 作為已審核會員，我希望在首頁看到個人使用統計和平台整體數據，以及我的活躍度等級。

#### 驗收標準
1. WHEN 會員查看首頁 THEN 系統 SHALL 顯示今日上傳/查詢次數和剩餘額度
2. WHEN 會員查看區域統計 THEN 系統 SHALL 顯示各區域債務人數量（含灌水數據）
3. WHEN 會員活動增加 THEN 系統 SHALL 根據上傳和查詢總數計算活躍度等級
4. WHEN 會員等級提升 THEN 系統 SHALL 更新稱號並發送通知

### 需求 13：管理員後台增強功能

**用戶故事：** 作為系統管理員，我希望擁有完整的管理工具來高效管理平台運營。

#### 驗收標準
1. WHEN 管理員查看儀表板 THEN 系統 SHALL 顯示即時統計和系統健康狀況
2. WHEN 管理員進行批量操作 THEN 系統 SHALL 支援批量審核和批量暫停功能
3. WHEN 管理員查看會員詳情 THEN 系統 SHALL 顯示完整的活動歷史和上傳統計
4. WHEN 管理員管理債務資料 THEN 系統 SHALL 提供編輯、刪除和統計分析功能
5. WHEN 管理員調整區域統計 THEN 系統 SHALL 允許修改灌水數據顯示

### 需求 14：會員互動與資訊展示系統

**用戶故事：** 作為已審核會員，我希望能夠查看其他會員的資訊並進行互動，增強平台社群感。

#### 驗收標準
1. WHEN 會員查詢債務資料 THEN 系統 SHALL 顯示上傳者的會員資訊卡
2. WHEN 會員查看資訊卡 THEN 系統 SHALL 顯示等級、稱號、勳章和按讚數
3. WHEN 會員對其他會員按讚 THEN 系統 SHALL 記錄按讚並更新統計
4. WHEN 會員資訊更新 THEN 系統 SHALL 即時更新所有相關顯示

### 需求 15：管理員自訂系統配置

**用戶故事：** 作為系統管理員，我希望能夠自訂活躍度系統的各項參數和規則。

#### 驗收標準
1. WHEN 管理員設定積分規則 THEN 系統 SHALL 允許修改上傳和查詢的積分值
2. WHEN 管理員自訂稱號 THEN 系統 SHALL 允許修改等級稱號和視覺效果
3. WHEN 管理員設定勳章 THEN 系統 SHALL 允許創建和修改勳章獲取條件
4. WHEN 管理員查看統計 THEN 系統 SHALL 同時顯示實際數據和展示數據

### 需求 16：系統備份與維護機制

**用戶故事：** 作為平台營運者，我希望系統具備完善的備份和維護機制，確保資料安全和系統穩定。

#### 驗收標準
1. WHEN 系統運行 THEN 系統 SHALL 定期自動備份重要資料
2. WHEN 日誌檔案增長 THEN 系統 SHALL 自動輪轉和清理舊日誌
3. WHEN API 版本更新 THEN 系統 SHALL 維持向後相容性
4. WHEN 系統異常 THEN 系統 SHALL 自動恢復並發送告警通知