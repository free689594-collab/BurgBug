# 階段 B：統計數據系統 - 差異分析報告

## 執行日期
2025-01-14

## 分析範圍
對照專案規劃文件（design.md, requirements.md, tasks.md）與階段 B 實作內容，進行全面差異分析。

---

## 一、需求比對結果

### 1.1 需求 12：會員首頁統計與活躍度系統

| 驗收標準 | 原始需求 | 階段 B 實作 | 狀態 | 備註 |
|---------|---------|------------|------|------|
| 12.1 顯示今日上傳/查詢次數和剩餘額度 | ✅ 必須 | ✅ 已實作 | 完成 | `/api/stats/member` 回傳配額資訊 |
| 12.2 顯示各區域債務人數量（含灌水數據） | ✅ 必須 | ❌ **未實作** | **缺失** | 應顯示 6 小區的展示數據 |
| 12.3 根據上傳和查詢總數計算活躍度等級 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於活躍度系統（階段 G） |
| 12.4 會員等級提升時更新稱號並發送通知 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於活躍度系統（階段 G） |

**缺失功能**：
- ❌ 區域統計 API (`/api/region/stats`)
- ❌ 會員 Dashboard 的區域統計圖表
- ❌ 展示數據（實際 + 灌水增量）計算邏輯

---

### 1.2 需求 13：管理員後台增強功能

| 驗收標準 | 原始需求 | 階段 B 實作 | 狀態 | 備註 |
|---------|---------|------------|------|------|
| 13.1 顯示即時統計和系統健康狀況 | ✅ 必須 | ✅ 已實作 | 完成 | 統計卡片已實作 |
| 13.2 支援批量審核和批量暫停功能 | ⚠️ 延後 | ❌ 未實作 | 延後 | 非階段 B 範圍 |
| 13.3 顯示完整的活動歷史和上傳統計 | ✅ 必須 | ✅ 已實作 | 完成 | 審計日誌已實作 |
| 13.4 提供編輯、刪除和統計分析功能 | ⚠️ 延後 | ❌ 未實作 | 延後 | 非階段 B 範圍 |
| 13.5 允許修改灌水數據顯示 | ✅ 必須 | ❌ **未實作** | **缺失** | 應提供調整 UI |

**缺失功能**：
- ❌ 區域統計對比組件（實際 vs 展示）
- ❌ 灌水數據調整 UI
- ❌ 灌水數據配置 API (`/api/admin/display-overrides`)

---

### 1.3 需求 14：會員互動與資訊展示系統

| 驗收標準 | 原始需求 | 階段 B 實作 | 狀態 | 備註 |
|---------|---------|------------|------|------|
| 14.1 顯示上傳者的會員資訊卡 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於會員互動系統 |
| 14.2 顯示等級、稱號、勳章和按讚數 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於活躍度系統 |
| 14.3 記錄按讚並更新統計 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於會員互動系統 |
| 14.4 即時更新所有相關顯示 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於會員互動系統 |

**說明**：需求 14 屬於「會員互動系統」，不在階段 B 範圍內，應在後續階段實作。

---

### 1.4 需求 15：管理員自訂系統配置

| 驗收標準 | 原始需求 | 階段 B 實作 | 狀態 | 備註 |
|---------|---------|------------|------|------|
| 15.1 允許修改上傳和查詢的積分值 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於活躍度系統配置 |
| 15.2 允許修改等級稱號和視覺效果 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於活躍度系統配置 |
| 15.3 允許創建和修改勳章獲取條件 | ⚠️ 可選 | ❌ 未實作 | 延後 | 屬於活躍度系統配置 |
| 15.4 同時顯示實際數據和展示數據 | ✅ 必須 | ❌ **未實作** | **缺失** | 應在管理員 Dashboard 顯示 |

**缺失功能**：
- ❌ 實際數據 vs 展示數據對比顯示

---

## 二、任務清單比對結果

### 2.1 任務 D：展示數據（灌水）配置

| 任務 | 原始規劃 | 階段 B 實作 | 狀態 | 備註 |
|------|---------|------------|------|------|
| D1 | DB：在 `system_config` 新增 key `display_overrides` | ❌ 未實作 | **缺失** | 資料庫配置缺失 |
| D2 | 後端：統計 API 回傳「實際」與「展示」 | ❌ 未實作 | **缺失** | API 邏輯缺失 |
| D3 | 前端（管理員）：提供每小區增量調整 UI | ❌ 未實作 | **缺失** | 管理介面缺失 |

**影響範圍**：
- 會員無法看到區域統計（含灌水數據）
- 管理員無法調整各區域的展示增量
- 管理員無法看到實際 vs 展示數據對比

---

### 2.2 任務 F：會員儀表板統計

| 任務 | 原始規劃 | 階段 B 實作 | 狀態 | 備註 |
|------|---------|------------|------|------|
| F1 | API：我的債務總額 `totalFaceValue` | ❌ 未實作 | **缺失** | 應在會員統計 API 回傳 |

**影響範圍**：
- 會員無法看到自己上傳的債務總額統計

---

### 2.3 任務 8：會員儀表板與統計

| 子任務 | 原始規劃 | 階段 B 實作 | 狀態 | 備註 |
|--------|---------|------------|------|------|
| 8.1 | 建立個人統計 API（含 totalFaceValue） | ⚠️ 部分實作 | **不完整** | 缺少 totalFaceValue |
| 8.1 | 實作區域統計 API（雙軌制數據） | ❌ 未實作 | **缺失** | 完全缺失 |
| 8.1 | 建立使用限制檢查 API | ✅ 已實作 | 完成 | 已整合在 `/api/stats/member` |
| 8.1 | 實作統計數據即時更新觸發器 | ❌ 未實作 | **缺失** | 資料庫觸發器缺失 |
| 8.2 | 設計會員儀表板頁面 | ✅ 已實作 | 完成 | `/dashboard` 已建立 |
| 8.2 | 實作個人統計顯示（含 totalFaceValue） | ⚠️ 部分實作 | **不完整** | 缺少 totalFaceValue |
| 8.2 | 建立區域統計圖表（雙軌數據） | ❌ 未實作 | **缺失** | 完全缺失 |
| 8.2 | 實作使用限制進度條 | ✅ 已實作 | 完成 | 查詢配額進度條已實作 |

---

## 三、設計文檔比對結果

### 3.1 管理員儀表板組件（design.md 第 806-868 行）

**原始設計**：
```typescript
export function AdminDashboard() {
  return (
    <div className="space-y-6">
      {/* 即時統計卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <StatCard title="待審核會員" ... />
        <StatCard title="今日上傳" ... />
        <StatCard title="今日查詢" ... />
        <StatCard title="系統健康" ... />
      </div>

      {/* 區域統計對比 */}
      <RegionStatsComparison realStats={stats?.regionRealStats} />

      {/* 活躍度系統配置 */}
      <ActivitySystemConfig />
    </div>
  );
}
```

**階段 B 實作**：
```typescript
// ✅ 已實作：即時統計卡片（8 個）
// ✅ 已實作：趨勢圖表（2 個）
// ✅ 已實作：地區分佈圓餅圖（1 個）
// ❌ 未實作：區域統計對比組件（RegionStatsComparison）
// ❌ 未實作：活躍度系統配置組件（ActivitySystemConfig）
```

**缺失組件**：
- ❌ `RegionStatsComparison` - 區域統計對比（實際 vs 展示）
- ❌ `ActivitySystemConfig` - 活躍度系統配置（延後至階段 G）

---

## 四、缺失功能清單

### 4.1 高優先級（必須補充）

#### 功能 1：展示數據（灌水）配置系統
**需求來源**：requirements.md 需求 12.2、13.5、15.4；tasks.md 任務 D

**具體內容**：
1. **資料庫配置**（D1）
   - 在 `system_config` 表新增 `display_overrides` 配置
   - 格式：`{ "北北基宜": 3, "桃竹苗": 1, "中彰投": 0, "雲嘉南": 2, "高屏澎": 0, "花東": 4 }`
   - 預設值：所有區域增量為 0

2. **區域統計 API**（D2）
   - 路徑：`/api/region/stats`
   - 權限：已登入會員可查看
   - 回傳格式：
     ```typescript
     {
       "北北基宜": {
         "actual": 100,      // 實際數據
         "display": 103,     // 展示數據（實際 + 增量）
         "override": 3       // 增量（僅管理員可見）
       },
       // ... 其他 5 個區域
     }
     ```

3. **管理員調整 API**（D2）
   - 路徑：`/api/admin/display-overrides`
   - 權限：僅管理員
   - 方法：GET（查詢）、PUT（更新）
   - 功能：即時更新各區域增量，無需重啟

4. **會員 Dashboard 區域統計**（8.2）
   - 位置：`/dashboard`
   - 顯示：6 小區的展示數據（實際 + 增量）
   - 視覺化：長條圖或圓餅圖

5. **管理員 Dashboard 區域對比**（D3）
   - 位置：`/admin/dashboard`
   - 組件：`RegionStatsComparison`
   - 顯示：實際數據 vs 展示數據對比表格
   - 功能：可即時調整各區域增量

**預估時間**：2-3 天

---

#### 功能 2：會員債務總額統計
**需求來源**：requirements.md 需求 12（會員儀表板統計）；tasks.md 任務 F1

**具體內容**：
1. **API 擴充**
   - 修改：`/api/stats/member`
   - 新增欄位：`totalFaceValue`（會員上傳的所有債務票面金額總和）
   - 計算邏輯：
     ```sql
     SELECT SUM(face_value) 
     FROM debt_records 
     WHERE uploaded_by = $1 AND deleted_at IS NULL
     ```

2. **前端顯示**
   - 位置：`/dashboard`
   - 顯示：「我的債務總額：$XXX,XXX」
   - 格式：千分位分隔，保留兩位小數

**預估時間**：0.5 天

---

#### 功能 3：統計數據即時更新觸發器
**需求來源**：tasks.md 任務 8.1

**具體內容**：
1. **資料庫觸發器**
   - 觸發時機：debt_records INSERT/UPDATE/DELETE
   - 更新目標：member_statistics 表
   - 更新欄位：uploads_count, totalFaceValue（新增）

2. **SQL 實作**：
   ```sql
   CREATE OR REPLACE FUNCTION update_member_statistics()
   RETURNS TRIGGER AS $$
   BEGIN
     IF TG_OP = 'INSERT' THEN
       UPDATE member_statistics
       SET uploads_count = uploads_count + 1,
           updated_at = NOW()
       WHERE user_id = NEW.uploaded_by;
     ELSIF TG_OP = 'DELETE' THEN
       UPDATE member_statistics
       SET uploads_count = GREATEST(uploads_count - 1, 0),
           updated_at = NOW()
       WHERE user_id = OLD.uploaded_by;
     END IF;
     RETURN COALESCE(NEW, OLD);
   END;
   $$ LANGUAGE plpgsql;
   ```

**預估時間**：0.5 天

---

### 4.2 中優先級（建議補充）

#### 功能 4：管理員即時統計更新（Realtime）
**需求來源**：design.md 管理員儀表板組件

**具體內容**：
1. **Supabase Realtime 訂閱**
   - 監聽表：debt_records, members
   - 事件：INSERT, UPDATE, DELETE
   - 自動刷新統計數據

2. **前端實作**：
   ```typescript
   useEffect(() => {
     const channel = supabase
       .channel('admin-stats')
       .on('postgres_changes',
         { event: '*', schema: 'public', table: 'debt_records' },
         () => refreshStats()
       )
       .subscribe();
     return () => supabase.removeChannel(channel);
   }, []);
   ```

**預估時間**：1 天

---

### 4.3 低優先級（可延後）

#### 功能 5：活躍度系統配置
**需求來源**：requirements.md 需求 15；design.md ActivitySystemConfig

**說明**：此功能屬於「階段 G：等級系統實作」，不在階段 B 範圍內。

**延後原因**：
- 需要完整的活躍度系統資料表（activity_system_config）
- 需要等級計算邏輯
- 需要勳章系統
- 複雜度高，應獨立成一個階段

---

## 五、遺漏原因分析

### 5.1 理解錯誤

**問題**：將「會員首頁統計」理解為「會員個人統計」

**原因**：
- 需求 12 的標題是「會員首頁統計與活躍度系統」
- 我過度聚焦在「個人統計」（上傳次數、查詢次數）
- 忽略了「平台整體數據」（區域統計）的部分

**影響**：
- 缺少區域統計 API
- 缺少展示數據（灌水）配置
- 會員 Dashboard 缺少區域統計圖表

---

### 5.2 範圍界定不清

**問題**：沒有明確區分「階段 B」與「階段 G」的範圍

**原因**：
- 需求 12 同時包含「統計」和「活躍度系統」
- 我將「活躍度系統」完全排除，但也排除了部分應該在階段 B 實作的統計功能

**影響**：
- 缺少 totalFaceValue 統計
- 缺少統計數據觸發器

---

### 5.3 文件檢視不完整

**問題**：沒有仔細檢視 tasks.md 的任務 D 和任務 F

**原因**：
- 過度依賴自己對「統計系統」的理解
- 沒有逐項核對任務清單
- 沒有注意到「展示數據（灌水）配置」是獨立的任務

**影響**：
- 完全遺漏任務 D（展示數據配置）
- 完全遺漏任務 F（債務總額統計）

---

### 5.4 設計文檔理解偏差

**問題**：沒有實作 `RegionStatsComparison` 組件

**原因**：
- 看到設計文檔中的組件名稱，但沒有深入理解其功能
- 誤以為這是「活躍度系統」的一部分
- 沒有意識到這是「展示數據對比」的核心組件

**影響**：
- 管理員無法看到實際 vs 展示數據對比
- 管理員無法調整灌水數據

---

## 六、補救計畫

### 6.1 優先級排序

| 優先級 | 功能 | 預估時間 | 依賴關係 |
|--------|------|---------|---------|
| P0 | 展示數據配置系統（D1, D2, D3） | 2-3 天 | 無 |
| P0 | 會員債務總額統計（F1） | 0.5 天 | 無 |
| P1 | 統計數據即時更新觸發器 | 0.5 天 | 無 |
| P2 | 管理員即時統計更新（Realtime） | 1 天 | P0 完成後 |
| P3 | 活躍度系統配置 | 延後至階段 G | - |

**總預估時間**：4-5 天

---

### 6.2 實作順序

#### 第 1 步：資料庫配置（0.5 天）
1. 在 `system_config` 表新增 `display_overrides` 配置
2. 建立統計數據更新觸發器
3. 測試觸發器功能

#### 第 2 步：API 開發（1.5 天）
1. 建立區域統計 API (`/api/region/stats`)
2. 建立管理員調整 API (`/api/admin/display-overrides`)
3. 擴充會員統計 API（加入 totalFaceValue）
4. 測試所有 API

#### 第 3 步：前端開發（2 天）
1. 建立 `RegionStatsComparison` 組件
2. 更新會員 Dashboard（加入區域統計圖表）
3. 更新管理員 Dashboard（加入區域對比和調整 UI）
4. 測試所有前端功能

#### 第 4 步：整合測試（0.5 天）
1. 完整功能測試
2. 效能測試
3. 建立測試報告

---

### 6.3 依賴關係圖

```
資料庫配置（D1）
    ↓
區域統計 API（D2）
    ↓
    ├─→ 會員 Dashboard 區域統計（8.2）
    └─→ 管理員調整 API（D2）
            ↓
        管理員 Dashboard 區域對比（D3）

會員統計 API 擴充（F1）
    ↓
會員 Dashboard 總額顯示

統計數據觸發器
    ↓
即時統計更新（可選）
```

---

## 七、總結

### 7.1 階段 B 完成度

| 類別 | 完成項目 | 缺失項目 | 完成率 |
|------|---------|---------|--------|
| API | 6 個 | 3 個 | 67% |
| 組件 | 3 個 | 1 個 | 75% |
| 頁面 | 3 個 | 0 個 | 100% |
| 資料庫 | 0 個 | 2 個 | 0% |
| **總計** | **12 個** | **6 個** | **67%** |

---

### 7.2 關鍵缺失

1. **展示數據（灌水）配置系統** - 完全缺失
2. **區域統計功能** - 完全缺失
3. **會員債務總額統計** - 完全缺失
4. **統計數據即時更新觸發器** - 完全缺失

---

### 7.3 建議

1. **立即補充 P0 功能**：展示數據配置和債務總額統計
2. **考慮補充 P1 功能**：統計數據觸發器
3. **延後 P3 功能**：活躍度系統配置（階段 G）
4. **加強文件檢視**：未來實作前務必逐項核對任務清單

---

**報告完成日期**：2025-01-14  
**報告撰寫者**：Augment Agent  
**下一步行動**：等待用戶確認補救計畫

